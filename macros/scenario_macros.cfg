
#define TAM_SET_INITIAL_VARIABLES

		# World Map variables
		{VARIABLE ship_x 35}
		{VARIABLE ship_y 9}
		{VARIABLE ship_type TAM_Cutter}
		{VARIABLE figurehead none}
		{VARIABLE global_counter 0}
		
		# Weapon variables
		# If these figures are changed remember to update the tooltips in abilities.cfg
		
		# Swing 5-4 > 12-4 (48 max) 7 times
		{VARIABLE slot_swing 0}
		{VARIABLE slot_next_swing 8}
		{VARIABLE slot_max_swing 12}
		# Jab 7-3 > 14-3 (42 max) 7 times
		{VARIABLE slot_jab 0}
		{VARIABLE slot_next_jab 7}
		{VARIABLE slot_max_jab 14}
		# Block 7-3 > 11-3 (33 max) 4 times
		{VARIABLE slot_block 0}
		{VARIABLE slot_next_block 6}
		{VARIABLE slot_max_block 11}
		# Smackdown  2-2 > 6-2 (12 max) 4 times
		{VARIABLE slot_smackdown 0}
		{VARIABLE slot_next_smackdown 5}
		{VARIABLE slot_max_smackdown 6}
		# Slingshot  4-2 > 7-2 (14 max) 3 times
		{VARIABLE slot_slingshot 0}
		{VARIABLE slot_next_slingshot 5}
		{VARIABLE slot_max_slingshot 7}
	
		# Slash 4-3 > 10-3 (27 max)  6 times
		{VARIABLE slot_slash 0}
		{VARIABLE slot_next_slash 7}
		{VARIABLE slot_max_slash 10}
		# Stab 6-2 > 10-2 (20 max) 4 times
		{VARIABLE slot_stab 0}
		{VARIABLE slot_next_stab 6}
		{VARIABLE slot_max_stab 10}
		# Quickfire 4-4 > 11-4 (44 max) 7 times
		{VARIABLE slot_quickfire 0}
		{VARIABLE slot_next_quickfire 8}
		{VARIABLE slot_max_quickfire 11}
		# Sureshot 8-3 > 12-3 (36 max) 4 times
		{VARIABLE slot_sureshot 0}
		{VARIABLE slot_next_sureshot 5}
		{VARIABLE slot_max_sureshot 12}
		# Firebow 12-2 > 15-2 (30 max) 3 times
		{VARIABLE slot_firebow 0}
		{VARIABLE slot_next_firebow 5}
		{VARIABLE slot_max_firebow 15}
		
		# Bank variables
		#{VARIABLE bank_counter 0}
		#{VARIABLE investment 0}
		
		# Log variables
		{VARIABLE log_marco no}
		{VARIABLE log_hilldon no}
		{VARIABLE log_ship no}
		{VARIABLE log_storm no}
		{VARIABLE log_drakes no}
		#{VARIABLE log_training 0}
		{VARIABLE log_trading_tips 0}
		#{VARIABLE training_1 0}
		#{VARIABLE training_2 0}
		
		# Inventory variables
		{VARIABLE inventory.tub 0}
				
		# Subquest variables
		{VARIABLE subquest_cell 0}
		{VARIABLE subquest_darcus 0}
		{VARIABLE subquest_fry 0}
		{VARIABLE subquest_tet 0}
		{VARIABLE subquest_nippy 0}
		{VARIABLE subquest_icewind 0}
		{VARIABLE subquest_winterbane 0}
		{VARIABLE subquest_serpent 0}
		{VARIABLE subquest_drunkard 0}
		{VARIABLE subquest_glade 0}
		{VARIABLE subquest_palmer 0}
		{VARIABLE subquest_steven 0}
		{VARIABLE subquest_bittertooth 0}
		{VARIABLE subquest_lab 0}
		{VARIABLE subquest_blade 0}
		{VARIABLE subquest_ratty 0}
		{VARIABLE subquest_cache 0}
		{VARIABLE subquest_moira 0}
		{VARIABLE subquest_gremlock 0}
		{VARIABLE subquest_polupa 0}
		{VARIABLE subquest_freemen 0}
		{VARIABLE subquest_yezza 0}
		{VARIABLE subquest_yezza_location greystone_port}
			{VARIABLE subquest_scorpions 0}
			{VARIABLE subquest_library 0}
			{VARIABLE subquest_trees 0}
			{VARIABLE subquest_reading 0}
			{VARIABLE subquest_dorm 0}
			{VARIABLE subquest_ivory 0}
			{VARIABLE subquest_droso 0}
		{VARIABLE subquest_hully 0}
		{VARIABLE subquest_calron 0}
			{VARIABLE subquest_newhart 0}
			{VARIABLE subquest_griply 0}
		{VARIABLE subquest_slanos 0}
		{VARIABLE subquest_iklon 0}
		{VARIABLE subquest_gaddon 0}
		{VARIABLE subquest_dud 0}

		# Random islands
		# Isle of Neafsey OR Hellenia
		{RANDOM isle_of_neafsey,hellenia}
		{VARIABLE random_island_4719 $random}
		# Newhart OR Gripley
		{RANDOM newhart,griply}
		{VARIABLE random_island_4126 $random}
		# Thurh Gar OR Reef Town
		{RANDOM thurh_gar,reef_town}
		{VARIABLE random_island_2720 $random}
			{CLEAR_VARIABLE random}
		
		# Location variables
		{VARIABLE avalon z}
		{VARIABLE hideout a}
		{VARIABLE port_rutt a}
		{VARIABLE farmville a}
		{VARIABLE farrow a}
		{VARIABLE elixion a}
		{VARIABLE fort_bastille a}
		{VARIABLE greystone_port a}
		{VARIABLE thantos_jungle a}
		{VARIABLE polupa a}
		{VARIABLE morteau a}
		{VARIABLE thurh_gar a}
		{VARIABLE reef_town a}
		{VARIABLE blade_point a}
		{VARIABLE hellenia a}
		{VARIABLE isle_of_neafsey a}
		{VARIABLE ivory_tower a}
		{VARIABLE newhart a}
		{VARIABLE griply a}
		{VARIABLE lludwyn a}
		{VARIABLE tomb a}
		
		# Hidden locations (these should be set to 'z')
		{VARIABLE dahazi_beach z}
		{VARIABLE judro_pits z}
		{VARIABLE fire_abbey z}
		{VARIABLE temple_of_ice z}
		#{VARIABLE colchis z}
		{VARIABLE royal_palace z}
		{VARIABLE lantos z}
		{VARIABLE peoria_ruins z}
		{VARIABLE black_rock z}
		{VARIABLE slavenia z}
		{VARIABLE solant z}
		{VARIABLE fort_liberty z}
		{VARIABLE mertropolis z}
		
		# Initial trading variables
		{VARIABLE log_trading_tips 0}
		{VARIABLE rum 0}
		{VARIABLE jewels 0}
		{VARIABLE spices 0}
		{VARIABLE rum_max 2}
		{VARIABLE jewels_max 2}
		{VARIABLE spices_max 2}
		{VARIABLE stash_hideout_rum 0}
		{VARIABLE stash_hideout_jewels 0}
		{VARIABLE stash_hideout_spices 0}
		{VARIABLE stash_black_rock_rum 0}
		{VARIABLE stash_black_rock_jewels 0}
		{VARIABLE stash_black_rock_spices 0}
		
		# Trading Port variables
		
		# Dahazi Beach
		{VARIABLE rum_dahazi_price 30}
		{VARIABLE jewels_dahazi_price 29}
		{VARIABLE spices_dahazi_price 5}
			{VARIABLE spices_dahazi_stock 5}
		# Fort Bastille
		{VARIABLE rum_bastille_price 33}
		{VARIABLE jewels_bastille_price 34}
		{VARIABLE spices_bastille_price 14}
		# Greystone Port
		{VARIABLE rum_greystone_price 16}
		{VARIABLE jewels_greystone_price 18}
		{VARIABLE spices_greystone_price 31}
		# Port Rutt
		{VARIABLE rum_rutt_price 25}
		{VARIABLE jewels_rutt_price 26}
		{VARIABLE spices_rutt_price 14}
		# Thurh Gar
		{VARIABLE rum_thurh_gar_price 23}
		{VARIABLE jewels_thurh_gar_price 5}
		{VARIABLE spices_thurh_gar_price 29}
			{VARIABLE jewels_thurh_gar_stock 0}
			{VARIABLE jewels_thurh_gar_counter 1}
		# Reef Town
		{VARIABLE rum_reef_town_price 23}
		{VARIABLE jewels_reef_town_price 5}
		{VARIABLE spices_reef_town_price 29}
			{VARIABLE jewels_reef_town_stock 0}
			{VARIABLE jewels_reef_town_counter 1}
		# Newhart
		{VARIABLE rum_newhart_price 5}
		{VARIABLE jewels_newhart_price 23}
		{VARIABLE spices_newhart_price 30}
			{VARIABLE rum_newhart_stock 0}
			{VARIABLE rum_newhart_counter 1}
		# Griply
		{VARIABLE rum_griply_price 5}
		{VARIABLE jewels_griply_price 23}
		{VARIABLE spices_griply_price 30}
			{VARIABLE rum_griply_stock 0}
			{VARIABLE rum_griply_counter 1}
		
		# The gaol map needs to be 50x32 hexes to accomodate these variables which are set on gaol-a
		 # Ivory Trees
		#[store_locations]
		#	x=45,45,45,49,49,49
		#	y=27,29,31,27,29,31
		#	variable=ivory_trees_xy
		#	[or]
		#		find_in=ivory_trees_xy
		#	[/or]
		#[/store_locations]		
		# Thantos Temples
		[store_locations]
			x="35,38,34,35,20,27"
			y="4,7,10,16,13,7"
			variable=thantos_temple_xy
			[or]
				find_in=thantos_temple_xy
			[/or]
		[/store_locations]
		# Hellenia Temples
		[store_locations]
			x="29,23,26,29,34,37,40"
			y="16,11,9,8,16,15,13"
			variable=hellenia_temple_xy
			[or]
				find_in=hellenia_temple_xy
			[/or]
		[/store_locations]
		# Ivory Tower Bookcases
		[store_locations]
			x="9,11,13,15,19,21,23,25,9,11,13,15,19,21,23,25,11,13,21,23"
			y="7,7,7,7,7,7,7,7,9,9,9,9,9,9,9,9,11,11,11,11"
			variable=ivory_bookcase_xy
			[or]
				find_in=ivory_bookcase_xy
			[/or]
		[/store_locations]
		# Temple of Ice
		[store_locations]
			x="45,46"
			y="10,9"
			variable=ice_temple_rum_xy
			[or]
				find_in=ice_temple_rum_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=22
			y=11
			variable=ice_temple_gold_xy
			[or]
				find_in=ice_temple_gold_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=20
			y=12
			variable=ice_temple_orb_xy
			[or]
				find_in=ice_temple_orb_xy
			[/or]
		[/store_locations]
		# Magic Mushrooms (also on farrow-a, deep_inside, and tomb-a)
		[store_locations]
			x=30
			y=4
			variable=shroom_gaol_xy
			[or]
				find_in=shroom_gaol_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=35
			y=9
			variable=shroom_lludwyn_xy
			[or]
				find_in=shroom_lludwyn_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=20
			y=3
			variable=shroom_solant_xy
			[or]
				find_in=shroom_solant_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=27
			y=9
			variable=shroom_peoria_xy
			[or]
				find_in=shroom_peoria_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=16
			y=2
			variable=shroom_shipwreck_xy
			[or]
				find_in=shroom_shipwreck_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=23
			y=14
			variable=shroom_cavern_xy
			[or]
				find_in=shroom_cavern_xy
			[/or]
		[/store_locations]
		[store_locations]
			x=25
			y=11
			variable=shroom_slavenia_xy
			[or]
				find_in=shroom_slavenia_xy
			[/or]
		[/store_locations]
#enddef

####################################################################################
# Schedules
####################################################################################

#define TOD_UNDERWATER
[time]
	id=underwater
	name= _ "Underwater"
	image=misc/schedule-underwater.png
	#lawful_bonus=0
	red=-90
	green=-80
	blue=10
[/time]
#enddef

#define TOD_BELLY
[time]
	id=belly
	name= _ "Inside"
	image=misc/schedule-belly.png
[/time]
#enddef

#define TOD_TITLE
[time]
	id=title
	name= _ "World Map"
	image=misc/schedule-title.png
[/time]
#enddef

#define TOD_INDOORS
[time]
	id=indoors
	name= _ "Indoors"
	image=misc/schedule-indoors.png
[/time]
#enddef

#define TOD_INDOORS_DARK
[time]
	id=indoors_dark
	name= _ "Indoors"
	image=misc/schedule-indoors-dark.png
	lawful_bonus=-25
	red=-40
	green=-40
	blue=-10
[/time]
#enddef

#define TOD_NEUTRAL_UNDERGROUND
[time]
	id=tam_neutral_underground
	name= _ "Underground"
	image=misc/time-schedules/schedule-underground.png
	red=-60
	green=-45
	blue=-25
[/time]
#enddef

#define TAM_ILLUMINATED_UNDERGROUND
[time]
	id=tam_illuminated_underground
	name= _ "Underground"
	image=misc/time-schedules/schedule-underground.png
	lawful_bonus=25
[/time]
#enddef

####################################################################################
# AMLA 
####################################################################################

#define AMLA_TAM_MARINER

# Health
[advancement]
	strict_amla=yes
	max_times=100
	id=amla_health
	always_display=yes
	description= "<span color='{TAM_BLUE}'>" + _"Health" + "</span>
" + _ "+3 Max HP"
	image="icons/amla-default.png"
	[effect]
		apply_to=hitpoints
		increase_total=3
		heal_full=yes
	[/effect]
	[effect]
		apply_to=status
		remove=poisoned
	[/effect]
	[effect]
		apply_to=status
		remove=slowed
	[/effect]
	[effect]
		apply_to=max_experience
		increase=10%
	[/effect]
[/advancement]

# Speed
[advancement]
	strict_amla=yes
	max_times=1
	id=amla_speed
	description= "<span color='{TAM_BLUE}'>" + _"Speed" + "</span>
" + _ "+1 Max Movement"
	image="icons/boots_elven.png"
	[effect]
		apply_to=movement
		increase=1
	[/effect]
	[effect]
		apply_to=hitpoints
		heal_full=yes
	[/effect]
	[effect]
		apply_to=status
		remove=poisoned
	[/effect]
	[effect]
		apply_to=status
		remove=slowed
	[/effect]
	[effect]
		apply_to=max_experience
		increase=10%
	[/effect]
[/advancement]

# Armour
[advancement]
	strict_amla=yes
	max_times=1
	id=amla_armour
	description= "<span color='{TAM_BLUE}'>" + _"Armour" + "</span>
" + _ "+10% To All Resistances"
	image="icons/armor_leather.png"
	[effect]
		apply_to=resistance
		[resistance]
			arcane=-10
			fire=-10
			cold=-10
			blade=-10
			impact=-10
			pierce=-10
		[/resistance]
	[/effect]
	[effect]
		apply_to=hitpoints
		heal_full=yes
	[/effect]
	[effect]
		apply_to=status
		remove=poisoned
	[/effect]
	[effect]
		apply_to=status
		remove=slowed
	[/effect]
	[effect]
		apply_to=max_experience
		increase=10%
	[/effect]
[/advancement]

# Wisdom
[advancement]
	strict_amla=yes
	max_times=1
	id=amla_wisdom
	description= "<span color='{TAM_BLUE}'>" + _"Wisdom" + "</span>
" + _ "-25% Max XP"
	image="icons/scroll_red.png"
	[effect]
		apply_to=max_experience
		increase=-25%
	[/effect]
	[effect]
		apply_to=hitpoints
		heal_full=yes
	[/effect]
	[effect]
		apply_to=status
		remove=poisoned
	[/effect]
	[effect]
		apply_to=status
		remove=slowed
	[/effect]
[/advancement]

#enddef
    
####################################################################################
# Scenario Macros
####################################################################################

#define TAM_LOCATION_ADDED
	[object]
		image=misc/tam-map.png
		description=_ "
" + _ "A new location has been added to your map."
	[/object]
#enddef

#define TAM_ITEM_ADDED
	[object]
		image=misc/tam-inventory.png
		description=_ "
" + _ "A new item has been added to your inventory."
	[/object]
#enddef

#define TAM_PLACE_FOLLOWERS
	[store_unit]
		[filter]
			side=1
			x,y=recall,recall
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml] 
		[/filter]
		variable=stored_units
		kill=no
	[/store_unit]
	{FOREACH stored_units i}
	[recall]
		id=$stored_units[$i].id
		show=no
		check_passability=no
	[/recall]
	{NEXT i}
	[clear_variable]
		name=stored_units
	[/clear_variable]
	
	[store_unit]
		[filter]
			side=2
			x,y=recall,recall
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml] 
		[/filter]
		variable=stored_units
		kill=no
	[/store_unit]
	{FOREACH stored_units i}
	[recall]
		id=$stored_units[$i].id
		show=no
		check_passability=no
	[/recall]
	{NEXT i}
	[clear_variable]
		name=stored_units
	[/clear_variable]
#enddef

#define TAM_PLACE_FOLLOWERS_ON_SHIP
	[store_unit]
		[filter]
			side=1
			x,y=recall,recall
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml] 
		[/filter]
		variable=stored_units
		kill=no
	[/store_unit]
	{FOREACH stored_units i}
	[recall]
		id=$stored_units[$i].id
		x,y=7,4
		show=no
		check_passability=no
	[/recall]
	{NEXT i}
	[clear_variable]
		name=stored_units
	[/clear_variable]
	
	[store_unit]
		[filter]
			side=2
			x,y=recall,recall
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml] 
		[/filter]
		variable=stored_units
		kill=no
	[/store_unit]
	{FOREACH stored_units i}
	[recall]
		id=$stored_units[$i].id
		x,y=7,4
		show=no
		check_passability=no
	[/recall]
	{NEXT i}
	[clear_variable]
		name=stored_units
	[/clear_variable]
#enddef

#define TAM_EXIT X Y
	[remove_shroud]
		side=1,2
		x={X}
		y={Y}
		radius=1
		terrain=!,Xu,Xv,Xt,*^Xo,Xos,Md^Xm,Mm^Xm,_off^_usr
	[/remove_shroud]
	{TAM_REDRAW}
	{HIGHLIGHT_IMAGE {X} {Y} items/gohere.png misc/blank-hex.png}
	[event]
		name=moveto
		[filter]
			x={X}
			y={Y}
			side=1,2
		[/filter]
		[remove_item]
			x,y={X},{Y}
		[/remove_item]
		[endlevel]
			result=victory
			continue_no_save=yes
			carryover_percentage=100
			bonus=no
			carryover_report=no
			linger_mode=no
			reveal_map=no
			next_scenario=meta-map
		[/endlevel]
	[/event]
#enddef

#define TAM_GLOBAL_EVENTS
	#{TAM_ATTACK_BONUS 0 swing 12}
	#{TAM_ATTACK_BONUS 1 jab 15}
	#{TAM_ATTACK_BONUS 2 block 11}
	#{TAM_ATTACK_BONUS 3 smash 20}
	#{TAM_ATTACK_BONUS 3 slingshot 20}

	#{TAM_ATTACK_BONUS 0 slash 9}
	#{TAM_ATTACK_BONUS 1 quickfire 11}
	#{TAM_ATTACK_BONUS 2 stab 10}
	#{TAM_ATTACK_BONUS 3 sureshot 12}
	#{TAM_ATTACK_BONUS 4 firebow 17}
	
	[event]
	name=prestart
		{TAM_STORE_UNIT side=1 canrecruit=yes (
		{VARIABLE stored_unit.id Largo}
		{VARIABLE stored_unit.name Largo}
		)}
		{TAM_STORE_UNIT side=2 canrecruit=yes (
		{VARIABLE stored_unit.id Hugo}
		{VARIABLE stored_unit.name Hugo}
		)}
		#{TAM_GIVING}
		#{TAM_HELP}
		#{TAM_LOG}
		#{TAM_INVENTORY}
		#{TAM_ASSIGN_FOLLOWER}
		#{TAM_FIGUREHEAD_MENU}
	[/event]
	
	{TAM_PICK_UP_GOODS}
	{TAM_ABILITY_EVENTS}
	{TAM_FIGUREHEAD_EVENTS}

	[event]
	name="new turn"
	first_time_only=no
		{VARIABLE_OP global_turns add 1}
	[/event]
	
	# Weapon damage increase
	[event]
	name="attack end"
	first_time_only=no
		[filter]
			canrecruit=yes
			side=1,2
		[/filter]

		{VARIABLE_OP slot_$weapon.name add 1}
		
		[if]
		{CONDITION slot_$weapon.name greater_than_equal_to $slot_next_$weapon.name}
		{CONDITION weapon.damage less_than $slot_max_$weapon.name}
			[then]
				{VARIABLE slot_next_$weapon.name $slot_$weapon.name}
				{VARIABLE_OP slot_next_$weapon.name multiply 1.2}
				{VARIABLE slot_$weapon.name 0}
				[object]
					silent=yes
					duration=forever
					[effect]
						apply_to=attack
						name=$weapon.name
						increase_damage=1
					[/effect]
				[/object]
				
				{VARIABLE temp_damage $weapon.damage}
				{VARIABLE_OP temp_damage add 1}
				[if]
				{CONDITION temp_damage numerical_equals $slot_max_$weapon.name}
					[then]
						[floating_text]
							x,y=$x1,$y1
							text="<span color='{TAM_BLUE}'>" + _ "float^Maxed Out: +1 Damage" + "</span>"
						[/floating_text]
						[object]
							silent=yes
							duration=forever
							[effect]
								apply_to=attack
								name=$weapon.name
								remove_specials=tam_upgrade_swing,tam_upgrade_jab,tam_upgrade_block,tam_upgrade_smackdown,tam_upgrade_slingshot,tam_upgrade_slash,tam_upgrade_stab,tam_upgrade_quickfire,tam_upgrade_sureshot,tam_upgrade_firebow
							[/effect]
						[/object]
					[/then]
					[else]
						[floating_text]
							x,y=$x1,$y1
							text="<span color='{TAM_BLUE}'>" + _ "float^+1 Damage" + "</span>"
						[/floating_text]
					[/else]
				[/if]
				{CLEAR_VARIABLE temp_damage}
			[/then]
		[/if]
	[/event]	
	
	# This adds the dummy upgrade weapon specials when mariners level up
	[event]
		name=post_advance
		first_time_only=no
		[filter]
			canrecruit=yes
			side=1,2
		[/filter]
		# Largo
		[if]
			[have_unit]
				side=1
				x,y=$x1,$y1
				level=2
				[has_attack]
					name=block
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=1 canrecruit=yes melee block (UPGRADE_BLOCK)}
			[/then]
		[/if]
		[if]
			[have_unit]
				side=1
				x,y=$x1,$y1
				level=3
				[has_attack]
					name=slingshot
					[not]
						damage=7
					[/not]
					[not]
						# To be deprecated: should be special_id as of 1.15.2
						special=tam_upgrade_slingshot
					[/not]
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=1 canrecruit=yes ranged slingshot (UPGRADE_SLINGSHOT)}
			[/then]
		[/if]
		[if]
			[have_unit]
				side=1
				x,y=$x1,$y1
				level=3
				[has_attack]
					name=smackdown
					[not]
						damage=6
					[/not]
					[not]
						special=tam_upgrade_smackdown
					[/not]
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=1 canrecruit=yes melee smackdown (UPGRADE_SMACKDOWN)}
			[/then]
		[/if]
		# Hugo
		[if]
			[have_unit]
				side=2
				x,y=$x1,$y1
				level=2
				[has_attack]
					name=stab
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=2 canrecruit=yes melee stab (UPGRADE_STAB)}
			[/then]
		[/if]
		[if]
			[have_unit]
				side=2
				x,y=$x1,$y1
				level=3
				[has_attack]
					name=sureshot
					[not]
						damage=12
					[/not]
					[not]
						special=tam_upgrade_sureshot
					[/not]
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=2 canrecruit=yes ranged sureshot (UPGRADE_SURESHOT)}
			[/then]
		[/if]
		[if]
			[have_unit]
				side=2
				x,y=$x1,$y1
				level=3
				[has_attack]
					name=firebow
					[not]
						damage=15
					[/not]
					[not]
						special=tam_upgrade_firebow
					[/not]
				[/has_attack]
			[/have_unit]
			[then]
				{TAM_ADD_WEAPON_SPECIAL side=2 canrecruit=yes ranged firebow (UPGRADE_FIREBOW)}
			[/then]
		[/if]
	[/event]
		
	#[event]
	#	name=post_advance
	#	first_time_only=no
	#	[filter]
	#		role=ship
	#		ability=extra_cargo
	#	[/filter]
	#	{TAM_REMOVE_ABILITY x=$x1 y=$y1 {TAM_ABILITY_EXTRA_CARGO}}
	#	{VARIABLE_OP rum_max add 1}
	#	{VARIABLE_OP jewels_max add 1}
	#	{VARIABLE_OP spices_max add 1}
	#	{TAM_REFRESH_CARGO_LABELS}
	#[/event]

	# Deaths
	[event]
	name=die
	first_time_only=no
		[filter]
			canrecruit=yes
			side=1,2
		[/filter]
		[message]
			speaker=unit
			message=_ "Damn Wesnoth and its unfair RNG!"
		[/message]
		[endlevel]
			result=defeat
			reveal_map=no
		[/endlevel]
	[/event]
	
	# Glutton
	[event]
		name="side turn"
		first_time_only=no
		[filter_condition]
			[have_unit]
				side=1,2
				side=$side_number
				canrecruit=yes
				ability=tam_curse_glutton
				[filter_location]
					terrain=*^V*,*^Ztv,*^Zwv
				[/filter_location]
			[/have_unit]
		[/filter_condition]
		[store_unit]
			[filter]
				side=$side_number
				canrecruit=yes
			[/filter]
			variable=glutton
		[/store_unit]
		{VARIABLE glutton.status.slowed yes}
		[unstore_unit]
			variable=glutton
			text= _ "Slowed"
			{COLOR_HARM}
		[/unstore_unit]
		{CLEAR_VARIABLE glutton}
	[/event]
	
	# Invisibilty is removed at turn start
	[event]
		name="side turn"
		first_time_only=no
		[filter_condition]
			[have_unit]
				side=1,2
				side=$side_number
				canrecruit=yes
				ability=tam_invisible
			[/have_unit]
		[/filter_condition]
		{TAM_REMOVE_ABILITY canrecruit=yes side=$side_number {TAM_ABILITY_INVISIBLE}}
	[/event]
	# Invisibilty is removed if a player moves next to an enemy
	#[event]
	#	name="moveto"
	#	first_time_only=no
	#	[filter]
	#		canrecruit=yes
	#		side=1,2
	#		ability=tam_invisible
	#		[filter_adjacent]
	#			is_enemy=yes
	#		[/filter_adjacent]
	#	[/filter]
	#	{TAM_REMOVE_ABILITY x=$x1 y=$y1 {TAM_ABILITY_INVISIBLE}}
	#[/event]
	# Invisibilty is removed if an enemy moves next to player 1
	#[event]
	#	name="moveto"
	#	first_time_only=no
	#	[filter]
	#		[not]
	#			side=1,2
	#		[/not]
	#		[filter_adjacent]
	#			is_enemy=yes
	#			ability=tam_invisible
	#			side=1
	#			canrecruit=yes
	#		[/filter_adjacent]
	#	[/filter]
	#	{TAM_REMOVE_ABILITY canrecruit=yes side=1 {TAM_ABILITY_INVISIBLE}}
	#[/event]
	# Invisibilty is removed if an enemy moves next to player 2
	#[event]
	#	name="moveto"
	#	first_time_only=no
	#	[filter]
	#		[not]
	#			side=1,2
	#		[/not]
	#		[filter_adjacent]
	#			is_enemy=yes
	#			ability=tam_invisible
	#			side=2
	#			canrecruit=yes
	#		[/filter_adjacent]
	#	[/filter]
	#	{TAM_REMOVE_ABILITY canrecruit=yes side=2 {TAM_ABILITY_INVISIBLE}}
	#[/event]
	
####################################################################################
# Follower dialogue
####################################################################################

	# Ogres - Ordon
	[event]
	name="last breath"
	first_time_only=no
		[filter]
			id=Ordon
			race=ogre
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "We go now, sorry master!"
		[/message]
		{VARIABLE npc_ordon dead}
	[/event]
	[event]
	name="post advance"
	first_time_only=no
		[filter]
			id=Ordon
			race=ogre
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Yes! $unit.name is big fighter!"
		[/message]
	[/event]
	# Ogres - Mocco
	[event]
	name="last breath"
	first_time_only=no
		[filter]
			id=Mocco
			race=ogre
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "No! Not good!"
		[/message]
		{VARIABLE npc_mocco dead}
	[/event]
	[event]
	name="post advance"
	first_time_only=no
		[filter]
			id=Mocco
			race=ogre
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "$unit.name feel stronger! Bash heads more!"
		[/message]
	[/event]
	
	# Sayer
	[event]
	name="last breath"
		[filter]
			id=Sayer
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "The soul goes the way of flesh. So be it."
		[/message]
	[/event]
	[event]
	name="post advance"
		[filter]
			id=Sayer
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "My soul withers further even as I grow stronger."
		[/message]
	[/event]
	
	# Nippy
	[event]
	name="last breath"
		[filter]
			id=Nippy
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Tell the Brotherhood I..."
		[/message]
	[/event]
	[event]
	name="post advance"
		[filter]
			id=Nippy
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "My powers grow ever greater!"
		[/message]
	[/event]
	
	# Bighorn
	[event]
	name="last breath"
		[filter]
			id=Bighorn
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Seems my horn just wasn't big enough..."
		[/message]
	[/event]
	[event]
	name="post advance"
		[filter]
			id=Bighorn
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "No one can touch me now. Bring it on!"
		[/message]
	[/event]
	
	# Ratty
	[event]
	name="last breath"
		[filter]
			id=Ratty
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Whimper..."
		[/message]
		[message]
			side=$unit.side
			canrecruit=yes
			message=_ "Poor, Ratty. I always knew his temper would get him into trouble."
		[/message]
	[/event]
	[event]
	name="post advance"
		[filter]
			id=Ratty
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Woof! Woof! Woof!"
		[/message]
	[/event]
	
	# Steven
	[event]
	name="last breath"
		[filter]
			id=Steven
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "Argh..."
		[/message]
	[/event]
	[event]
	name="post advance"
		[filter]
			id=Steven
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			id=Steven
			level=1
			message=_ "I'm learning. I'm gonna make the old man proud."
		[/message]
		[message]
			id=Steven
			level=2
			message=_ "Now I'm really getting somewhere!"
		[/message]
		[message]
			id=Steven
			level=3
			message=_ "If only the old man could see me now!"
		[/message]
	[/event]

	# Kashmir
	[event]
	name="last breath"
		[filter]
			id=Kashmir
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "All that lives is born to die..."
		[/message]
		[/event]
		[event]
	name="post advance"
		[filter]
			id=Kashmir
			side=1,2
			[filter_wml]
				[modifications]
					[trait]
						id=follower
					[/trait]
				[/modifications]
			[/filter_wml]
		[/filter]
		[message]
			speaker=unit
			message=_ "War is the common cry, pick up your swords and fly!"
		[/message]
	[/event]
	
	# Dud
	[event]
	name="last breath"
		[filter]
			id=Dud
			side=1,2
		[/filter]
		[message]
			speaker=unit
			message=_ "Arawowoh!"
		[/message]
		{VARIABLE subquest_dud 6}
	[/event]

#enddef


	
####################################################################################
# Ship Decks
####################################################################################

#define TAM_MASK_TUB
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/tub.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_CUTTER
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/cutter.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_DHOW
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/dhow.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_CARAVEL
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/caravel.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_LONGBOAT
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/longboat.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_FRIGATE
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/frigate.mask}"
[/terrain_mask]
#enddef

#define TAM_MASK_GALLEON
[terrain_mask]
    x,y=1,1
    mask="{~add-ons/The_Altaz_Mariners/maps/masks/galleon.mask}"
[/terrain_mask]
#enddef

####################################################################################
# Ship Macros
####################################################################################

#define TAM_AI_GOLD_BONUS
	[event]
    name=start
		[if]
			{CONDITION global_turns greater_than 100}
			{CONDITION global_turns less_than_equal_to 500}
			[then]
				{TAM_GOLD 4 25}
			[/then]
		[/if]
		[if]
			{CONDITION global_turns greater_than 500}
			{CONDITION global_turns less_than_equal_to 1000}
			[then]
				{TAM_GOLD 4 50}
			[/then]
		[/if]
		[if]
			{CONDITION global_turns greater_than 1000}
			{CONDITION global_turns less_than_equal_to 1500}
			[then]
				{TAM_GOLD 4 75}
			[/then]
		[/if]
		[if]
			{CONDITION global_turns greater_than 1500}
			{CONDITION global_turns less_than_equal_to 2000}
			[then]
				{TAM_GOLD 4 100}
			[/then]
		[/if]
		[if]
			{CONDITION global_turns greater_than 2000}
			[then]
				{TAM_GOLD 4 150}
			[/then]
		[/if]
		
		# Expand pirate recruit list
		[if]
			{CONDITION global_turns greater_than 1000}
			[have_unit]
				side=4
				canrecruit=yes
				type=Duelist
			[/have_unit]
			[then]
				[allow_recruit]
					side=4
					type=Trapper,Bandit,Rogue,Outlaw
				[/allow_recruit]
			[/then]
		[/if]
		
		# Expand orcish recruit list
		[if]
			{CONDITION global_turns greater_than 1000}
			[have_unit]
				side=4
				canrecruit=yes
				type="Orcish Warrior"
			[/have_unit]
			[then]
				[allow_recruit]
					side=4
					type=Orcish Warrior,Orcish Crossbowman,Orcish Slayer
				[/allow_recruit]
			[/then]
		[/if]
		
		# Expand royal recruit list
		[if]
			{CONDITION global_turns greater_than 1000}
			[have_unit]
				side=4
				canrecruit=yes
				type=Lieutenant
			[/have_unit]
			[then]
				[allow_recruit]
					side=4
					type=Swordsman,Pikeman,Javelineer,Longbowman,Shock Trooper,Duelist
				[/allow_recruit]
			[/then]
		[/if]
		
		# Expand undead recruit list
		[if]
			{CONDITION global_turns greater_than 1000}
			[have_unit]
				side=4
				canrecruit=yes
				type="Death Knight"
			[/have_unit]
			[then]
				[allow_recruit]
					side=4
					type=Deathblade,Revenant,Bone Shooter,Necrophage,Wraith
				[/allow_recruit]
			[/then]
		[/if]
	
	[/event]
	
	# This event is intended to cease recruitment on random encounters to stop them becoming xp farms
	[event]
	name="turn 9"
		[if]
			[have_unit]
				side=4
			[/have_unit]
			[then]
				{TAM_GOLD 4 -500}
			[/then]
		[/if]
	[/event]
#enddef

#define TAM_PLACING_PLAYER_VESSEL X Y
	[event]
	name=prestart

		[if]
		{CONDITION ship_type equals TAM_Cutter}
			[then]
				{TAM_MASK_CUTTER}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/cutter.png~TC(1,magenta)
				[/item]
				[item]
					x,y=7,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Dhow}
			[then]
				{TAM_MASK_DHOW}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/dhow.png~TC(1,magenta)
				[/item]
				[item]
					x,y=9,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Caravel}
			[then]
				{TAM_MASK_CARAVEL}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/caravel.png~TC(1,magenta)
				[/item]
				[item]
					x,y=11,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=1
					x,y=9,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Longboat}
			[then]
				{TAM_MASK_LONGBOAT}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/longboat.png~TC(1,magenta)
				[/item]
				[item]
					x,y=11,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=1
					x,y=3,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Pirate_Ship}
			[then]
				{TAM_MASK_FRIGATE}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/pirate-ship.png~TC(1,magenta)
				[/item]
				[item]
					x,y=13,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=1
					x,y=9,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Frigate}
			[then]
				{TAM_MASK_FRIGATE}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/frigate.png~TC(1,magenta)
				[/item]
				[item]
					x,y=13,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=1
					x,y=9,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
			[/then]
		[/if]
		[if]
		{CONDITION ship_type equals TAM_Galleon}
			[then]
				{TAM_MASK_GALLEON}
				{TAM_REFRESH_CARGO_LABELS}
				[item]
					x,y={X},{Y}
					image=units/ships/galleon.png~TC(1,magenta)
				[/item]
				[item]
					x,y=15,4
					image=scenery/figureheads/$figurehead|-statue.png
				[/item]
				[capture_village]
					side=1
					x,y=9,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=7,4
				[/capture_village]
				[capture_village]
					side=2
					x,y=11,4
				[/capture_village]
			[/then]
		[/if]
				
		{TAM_REDRAW}
		[remove_shroud]
			side=1,2
			x=1-16
			y=1-7
			radius=1
			[not]
				terrain=_off^_usr
			[/not]
		[/remove_shroud]
	[/event]
#enddef

#define TAM_DISEMBARKING_VESSEL FILTER_1 FILTER_2 X Y
	[event]
		name=moveto
		first_time_only=no
		[filter]
			{FILTER_1}
			{FILTER_2}
			[filter_location]
                terrain=Ww^ZBw|
            [/filter_location]
		[/filter]
		{TAM_STORE_UNIT x=$x1 y=$y1 ({VARIABLE_OP stored_unit.moves add 1})}
		[teleport]
		  [filter]
			x=$x1
			y=$y1
		  [/filter]
		  x={X}
		  y={Y}
		[/teleport]
		{TAM_SCROLL_TO {X} {Y}}
		{TAM_REDRAW}
	[/event]
#enddef

#define TAM_BOARDING_VESSEL FILTER_1 FILTER_2
	[event]
		name=moveto
		first_time_only=no
		[filter]
			{FILTER_1}
			{FILTER_2}
		[/filter]
		{TAM_STORE_UNIT x=$x1 y=$y1 ({VARIABLE_OP stored_unit.moves add 1})}
		[teleport]
		  [filter]
			x=$x1
			y=$y1
		  [/filter]
		  x=5
		  y=2
		[/teleport]
		{TAM_SCROLL_TO 5 2}
		{TAM_REDRAW}
	[/event]
#enddef

####################################################################################
# Random Terrain Generators
####################################################################################

#define TAM_GENERATE_SEA_TERRAIN
	[event]
    name=prestart
		[store_locations]
			terrain=Wo
			variable=tile
		[/store_locations]
		 
		{FOREACH tile i}
			{RANDOM 1..100}
			# Shallow water (40%)
			[if]
				{CONDITION random less_than_equal_to 40}
				[then]
					{MODIFY_TERRAIN Ww $tile[$i].x $tile[$i].y}
				[/then]
			[/if]
			# Reef (5%)
			[if]
				{CONDITION random greater_than 40}
				{CONDITION random less_than_equal_to 45}
				[then]
					{MODIFY_TERRAIN Wwr $tile[$i].x $tile[$i].y}
				[/then]
			[/if]
			# Ford (5%)
			[if]
				{CONDITION random greater_than 45}
				{CONDITION random less_than_equal_to 50}
				[then]
					{MODIFY_TERRAIN Wwf $tile[$i].x $tile[$i].y}
				[/then]
			[/if]
			# Deep water (50%)
		{NEXT i}

		{CLEAR_VARIABLE tile}
		{CLEAR_VARIABLE random}
	[/event]
#enddef

####################################################################################
# Random Auto-Recall
####################################################################################

#define TAM_RANDOM_RECALL SIDE X Y
		[store_unit]
		[filter]
			side={SIDE}
			level=4
			x,y=recall,recall
			[not]
				race=merman
			[/not]
			[not]
				race=naga
			[/not]
		[/filter]

			kill=no
			variable=possible_helpers
		[/store_unit]

        [if]
            [variable]
                name=possible_helpers.length
                equals=0
            [/variable]

            [then]
                [store_unit]
                    [filter]
                        side={SIDE}
                        level=3
                        x,y=recall,recall
                    [/filter]

                    kill=no
                    variable=possible_helpers
                [/store_unit]

                [if]
                    [variable]
                        name=possible_helpers.length
                        equals=0
                    [/variable]

                    [then]
                        [store_unit]
                            [filter]
                                side={SIDE}
                                level=2
                                x,y=recall,recall
                            [/filter]

                            kill=no
                            variable=possible_helpers
                        [/store_unit]

                        [if]
                            [variable]
                                name=possible_helpers.length
                                equals=0
                            [/variable]

                            [then]
                                [store_unit]
                                    [filter]
                                        side={SIDE}
                                        level=1
                                        x,y=recall,recall
                                    [/filter]

                                    kill=no
                                    variable=possible_helpers
                                [/store_unit]
                            [/then]
                        [/if]
                    [/then]
                [/if]
            [/then]
        [/if]

        [if]
            [variable]
                name=possible_helpers.length
                greater_than=0
            [/variable]

            [then]
                {VARIABLE_OP random_helper_i rand "1..$possible_helpers.length"}
                {VARIABLE_OP random_helper_i sub 1}

                [recall]
                    id=$possible_helpers[$random_helper_i].id
                    x={X}
					y={Y}
					show=no
                [/recall]

                {CLEAR_VARIABLE random_helper_i}
            [/then]
        [/if]
        {CLEAR_VARIABLE possible_helpers}
#enddef

####################################################################################
# Setting Islands
####################################################################################

# Blue: (51,153,255)
# Red: (255,0,0)
# Orange: (255,153,0)
# Yellow: (255,255,0)
# Green: (0,153,0)

#define TAM_SET_ISLAND X Y NAME COLOR STRING

	# Setting the labels
	[event]
	name=start
		[if]
			{CONDITION {NAME} equals a}
			[then]
				[label]
					x={X}
					y={Y}
					text={STRING}
					color={COLOR}
				[/label]
			[/then]
		[/if]
		[if]
			{CONDITION {NAME} not_equals a}
			{CONDITION {NAME} not_equals z}
			[then]
				[label]
					x={X}
					y={Y}
					text={STRING}
					color=0,153,0
				[/label]
			[/then]
		[/if]
	[/event]
	
	# Setting the labels for player 2
	[event]
		name=moveto
		first_time_only=no
		[filter]
			role=ship
		[/filter]
		[if]
			{CONDITION {NAME} equals a}
			[then]
				[label]
					x={X}
					y={Y}
					text={STRING}
					color={COLOR}
				[/label]
			[/then]
		[/if]
		[if]
			{CONDITION {NAME} not_equals a}
			{CONDITION {NAME} not_equals z}
			[then]
				[label]
					x={X}
					y={Y}
					text={STRING}
					color=0,153,0
				[/label]
			[/then]
		[/if]
	[/event]

	# Entering the island
	[event]
	name=moveto
	first_time_only=no
		[filter]
			x={X}
			y={Y}
		[/filter]
		[if]
			{CONDITION {NAME} equals a}
			[then]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario={NAME}-a
				[/endlevel]
			[/then]
		[/if]
		[if]
			{CONDITION {NAME} equals b}
			[then]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario={NAME}-b
				[/endlevel]
			[/then]
		[/if]
		[if]
			{CONDITION {NAME} equals c}
			[then]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario={NAME}-c
				[/endlevel]
			[/then]
		[/if]
		[if]
			{CONDITION {NAME} equals d}
			[then]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario={NAME}-d
				[/endlevel]
			[/then]
		[/if]
	[/event]
#enddef

####################################################################################
# Yezza
####################################################################################

# This macro is used in the following scenarios:
# port_rutt-a.cfg
# greystone_port-a.cfg
# newhart.cfg
# griply-a.cfg
# griply-c.cfg

#define TAM_YEZZA X Y X2 Y2
	[event]
		name=prestart
		# Does Yezza appear?
		[if]
			{CONDITION subquest_yezza less_than 4}
			{CONDITION subquest_yezza_location equals $scenario}
			[then]
				{TAM_PLACE_NPC 3 TAM_Pirate {X} {Y} Yezza}
				[+unit]
					profile=portraits/Yezza.png
				[/unit]
				[item]
					x,y={X2},{Y2}
					image=units/transport/boat.png~TC(3,magenta)
				[/item]
				# Set Yezza's next location
				{RANDOM greystone_port,port_rutt,random_island_4126}
				{VARIABLE subquest_yezza_location $random}
				{CLEAR_VARIABLE random}
			[/then]
		[/if]
	[/event]

	# Yezza's opening dialogue
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Yezza
                type=TAM_Pirate
                side=3
            [/filter_adjacent]
  		[/filter]
  		[filter_condition]
			{CONDITION subquest_yezza numerical_equals 0}
  		[/filter_condition]
  		
		[message]
			speaker=Yezza
			message=_ "Why, if it ain't the brothers back from their little old trip to Altaz..."
		[/message]
		[message]
			speaker=unit
			message=_ "So you're still hanging around are you? If there was one good thing about being locked up all that time, it was not having to hear your prattle."
		[/message]
		[message]
			speaker=Yezza
			message=_ "I see your spell on the inside didn't improve your manners none. Ain't it a treat to see a familiar face? Old Yezza's been worried sick about you lads!"
		[/message]
		[message]
			speaker=unit
			message=_ "Don't try that on. I doubt you did little more than chuckle when we got put away. Or perhaps you wove us into some tall tale to impress the wenches at the tavern?"
		[/message]
		[message]
			speaker=Yezza
			message=_ "You seem a little bitter, old chum. Not that I hold that against you! Anyways, I've got plenty of tavern tales more juicy than the story of the bickering brothers."
		[/message]
		{VARIABLE subquest_yezza 1}
	[/event]
		
	# Yezza's bragging game
	[event]
	name=moveto
		[filter]
			side=1,2
			canrecruit=yes
			[filter_adjacent]
				id=Yezza
				type=TAM_Pirate
				side=3
			[/filter_adjacent]
		[/filter]
  		
  		##########################################
		# Round 1
		##########################################
		
		[if]
		{CONDITION subquest_yezza numerical_equals 1}
			[then]
			
				# Yezza's boasts
				{RANDOM 1..3}
				[switch]
					variable=random
					[case]
						value=1
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I scuffled down a cockatrice with me bare hands? Knocked it stone cold!"
						[/message]
					[/case]
					[case]
						value=2
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I drank an orc slaver under the table? Fourteen tankards of grog it took! Couldn't see straight for a week..."
						[/message]
					[/case]
					[case]
						value=3
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I was on the run from the royals round Dahazi way? Hid inside a shipment, all cosy like, in with the spices. Clean got away I did, though your nose might beg to differ!"
						[/message]
					[/case]
				[/switch]
				{CLEAR_VARIABLE random}
				
				# Player boasts
				[message]
					speaker=narrator
					image=wesnoth-icon.png
					message= _ "What will you do?"
					
					# Walk on
					[option]
						description=_ "Walk on"
						[command]
							[message]
								speaker=unit
								message=_ "Leave me alone, you fool."
							[/message]
						[/command]
					[/option]
					
					# Altaz
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about escaping from Altaz Gaol" + "</span>"
						[command]
							[message]
								speaker=unit
								message=_ "That's nothing. You know we escaped from the harshest prison this side of Three Sisters?"
						[/message]
						[message]
							speaker=Yezza
							message=_ "Hah, and why be you there in the first place? Methinks Marco has more to brag about!"
						[/message]
						[/command]
					[/option]
					
					# Farmville
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about raiding Farmville" + "</span>"
						[show_if]
							{CONDITION farmville equals b}
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "Perhaps you didn't hear about our raid on Farmville? We put those peasants back in the dirt where they belong!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "You robbed some lowly farmboys and expect me to give a damn? Even Old Man Tet has better tales than that."
							[/message]
						[/command]
					[/option]
					
					# Dahazi
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about liberating Dahazi Beach" + "</span>"
						[show_if]
							{CONDITION dahazi_beach equals b}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 2}
							[message]
								speaker=unit
								message=_ "Maybe you missed the news of the rebellion on Dahazi Beach? We slew Sir Uden and ousted the royals from the island!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "That was you? Tylon must be miffed! I guess you must have been in the right place at the right time, as they say. Anyways, let me think..."
							[/message]
						[/command]
					[/option]
					
					# Judro
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about liberating Judro Pits" + "</span>"
						[show_if]
							{CONDITION judro_pits equals b}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 2}
							[message]
								speaker=unit
								message=_ "Remember Sir Ludolf? He used to run Judro Pits with an iron fist, but now he's dust. We led the rebellion there and kicked out the royals!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "That was you? Tylon must be miffed! I'm guessing you were simply in the right place at the right time, as they say. Anyways, let me think..."
							[/message]
						[/command]
					[/option]
					
					# Elixion
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about fighting on Elixion" + "</span>"
						[show_if]
							{CONDITION elixion equals b}
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "Didn't you hear? We defeated Sir Horas and his undead horde on Elixion! The fountain runs pure thanks to us..."
							[/message]
							[message]
								speaker=Yezza
								message=_ "So you pranced with some elves and got to play in their pretty little pond? Some pirates would rather soil their sails than admit to that!"
							[/message]
						[/command]
					[/option]
				[/message]
			[/then]
		[/if]
		
		##########################################
		# Round 2
		##########################################

		[if]
		{CONDITION subquest_yezza numerical_equals 2}
			[then]
				
				# Yezza's boasts
				{RANDOM 1..2}
				[switch]
					variable=random
					[case]
						value=1
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time my ship went down near Greystone? There I was clinging to a keg of rum floating free from the hold. Drank myself stupid I did, figuring it was me last chance. Only made it to land because of that blessed empty barrel! Drowning your sorrows keeps your head above the waves, that's what I say!"
						[/message]
					[/case]
					[case]
						value=2
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I got made a knight? There I was in the gambling hall when this royal somebody walks in, proper sloshed, and pins me down to a game of dice. He bets his badge and guess what? He straight up rolls a pair of snake eyes! I lost the very next round, but for a few proud moments old Yezza was a knight of the crown..."
						[/message]
					[/case]
				[/switch]
				{CLEAR_VARIABLE random}
				
				# Player boasts
				[message]
					speaker=narrator
					image=wesnoth-icon.png
					message= _ "What will you do?"
					
					# Walk on
					[option]
						description=_ "Walk on"
						[command]
							[message]
								speaker=unit
								message=_ "I've had enough of this."
							[/message]
						[/command]
					[/option]
					
					# Ivory Tower
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about defending the Ivory Tower" + "</span>"
						[show_if]
							{CONDITION subquest_ivory greater_than_equal_to 3}
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "You don't seem to be aware that you're speaking to a defender of the Ivory Tower. We repelled an orcish invasion and saved the city!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "You risked life and limb to save some dusty old parchments? For your sake, I hope nobody puts that boast down on paper."
							[/message]
						[/command]
					[/option]
					
					# Farrow
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about the battle on Farrow" + "</span>"
						[show_if]
							{CONDITION farrow equals b}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 3}
							[message]
								speaker=unit
								message=_ "We fought against overwhelming odds on Farrow at the head of a revolt against the evil Baron Lothar. Heard of any other pirates besting the royal army in a pitched battle?"
							[/message]
							[message]
								speaker=Yezza
								message=_ "No, I ain't. Not bad, not bad at all. I reckons I can top it though..."
							[/message]
						[/command]
					[/option]
					
					# Sea monster
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about your adventure inside a sea monster" + "</span>"
						[show_if]
							{CONDITION subquest_serpent greater_than_equal_to 2}
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "That's a poor boast when you hear what happened to us. We were swallowed by a ferocious sea monster and fought our way out of the very belly of the beast!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "Yawn. That tale would be harder to swallow if it weren't such an old one. We've all done a sea monster once or twice!"
							[/message]
						[/command]
					[/option]
					
					# Hilldon
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about killing Hilldon" + "</span>"
						[show_if]
							{CONDITION log_hilldon.duel equals dead}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 3}
							[message]
								speaker=unit
								message=_ "We tracked down the notorious pirate Hilldon to his lair at Black Rock. In a daring duel we felled the traitor and stole his treasure map."
							[/message]
							[message]
								speaker=Yezza
								message=_ "I loves it! And he was one of your own crew as well... what a tale! Bet I've got a better one in me though."
							[/message]
						[/command]
					[/option]
					
				[/message]
			[/then]
		[/if]
	
		##########################################
		# Round 3
		##########################################

		[if]
		{CONDITION subquest_yezza numerical_equals 3}
			[then]
				
				# Yezza's boasts
				{RANDOM 1..2}
				[switch]
					variable=random
					[case]
						value=1
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I got keelhauled? Dwarves it was, peeved at me plundering. Tied the ropes round me wrists, just like that, and threw me over. As I was bumping the barnacles I saw something glitter down under. Didn't get much of a peek, what with the water filling me lungs. But when I comes back up I spit square in this dwarf's beard, which made the stumpy fellow more peeved than ever."
						[/message]
						[message]
							speaker=Yezza
							message=_ "I was hoping for another dunking, see? Anyway, while I'm doing the rounds this time I keep me eyes peeled. And that's when I saw it! The city of Atlantis, as glorious as you like, sitting there in the sands. Yezza be the only living chap who ever saw it. How's that for a tale?"
						[/message]
					[/case]
					[case]
						value=2
						[message]
							speaker=Yezza
							message=_ "Ever tell you about the time I met me own ghost? Strange old tale this one. I was laying low in this lighthouse, hoping to get forty winks when all this howling starts outside. There's a knock at the door and I opens it, only to find there ain't nobody there. Just a big old gale hammering away. A little later the door goes again. This time I let it be, but the door opens anyways. And there he is, this fella looking like the spit of old Yezza himself. Then the wind blows and he goes, into thin air, like they say. I ain't got no clue what it means, but it happened just as I says."
						[/message]
					[/case]
				[/switch]
				{CLEAR_VARIABLE random}
				
				# Player boasts
				[message]
					speaker=narrator
					image=wesnoth-icon.png
					message= _ "What will you do?"
					
					# Walk on
					[option]
						description=_ "Walk on"
						[command]
							[message]
								speaker=unit
								message=_ "We've got better things to do than wag tongues with old fools."
							[/message]
						[/command]
					[/option]
					
					# Lludwyn
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about your victory against the trolls of Lludwyn" + "</span>"
						[show_if]
							{CONDITION lludwyn equals b}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 4}
							[message]
								speaker=unit
								message=_ "You seem so proud of your petty adventures, yet have you heard how we conquered the isle of Lludwyn? I'll have you know the legendary troll king is vanquished, his army buried, his treasure ours!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "I ain't heard that one before. Most fellows don't even joke about them trolls. I had you down as a bit of an oaf, but you ain't half bad with the old tale telling."
							[/message]
							[message]
								speaker=Yezza
								message=_ "Tell you what... Some chap tried to impress me with a tale about some treasure he was trying to dig up. I had to kill him in the end, but I still got his map. Don't fancy doing much digging myself. Here, take it. Anyway, nice to run into you chaps again."
							[/message]
							{TAM_ITEM_ADDED}
							{VARIABLE inventory.map_polupa 1}
						[/command]
					[/option]
					
					# Morteau
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about defeating Dr Morteau" + "</span>"
						[show_if]
							{CONDITION morteau equals c}
							[or]
								{CONDITION morteau equals d}
							[/or]
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "While you were wasting your time telling tales, we fought and defeated a powerful mage. Dr Morteau is no more, after we dropped his men and stormed his house of pain."
							[/message]
							[message]
								speaker=Yezza
								message=_ "Dr who? Never heard of him! If you're gonna go round killing mages, best be ones all feared and famous like. You'll have to try harder my friend!"
							[/message]
						[/command]
					[/option]
					
					# Thantos
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about the battle on Thantos" + "</span>"
						[show_if]
							{CONDITION thantos equals b}
						[/show_if]
						[command]
							[message]
								speaker=unit
								message=_ "Do you know Thantos? The island of elves and lost treasure? We've been through the jungle cutting down the forest folk and fighting a squadron of royals to boot."
							[/message]
							[message]
								speaker=Yezza
								message=_ "And what treasure did you find? Yezza heard all about that one already! Mind you, they say there be nice flowers round those parts. Haha!"
							[/message]
						[/command]
					[/option]
					
					# Royal Palace
					[option]
						description="<span color='{TAM_BLUE}'>" + _ "Brag about your mission to the royal palace" + "</span>"
						[show_if]
							{CONDITION royal_palace equals b}
						[/show_if]
						[command]
							{VARIABLE subquest_yezza 4}
							[message]
								speaker=unit
								message=_ "Nothing you say can match our daring raid on the royal palace. That's right, we sneaked right into Tylon's house and helped ourselves to whatever we could find. We even feasted in the tyrant's kitchen!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "I gotta hand this one to you fella. That stuff takes the guts of a fool, which I admire. Seems you are a braggart to behold!"
							[/message]
							[message]
								speaker=Yezza
								message=_ "Tell you what... Some chap tried to impress me with a tale about some treasure he was trying to dig up. I had to kill him in the end, but I still got his map. Don't fancy doing much digging myself. Here, take it. Anyway, nice to run into you chaps again."
							[/message]
							{TAM_ITEM_ADDED}
							{VARIABLE inventory.map_polupa 1}
						[/command]
					[/option]

				[/message]
			[/then]
		[/if]
		
		##########################################
		# Yezza leaves
		##########################################
			
		[message]
			speaker=Yezza
			message=_ "In any case, I best be off."
		[/message]
		[kill]
			side=3
			name=Yezza
			type=TAM_Pirate
			animate=no
		[/kill]
		[move_unit_fake]
			side=3
			name=Jezza
			type="TAM_Pirate"
			x={X},{X2}
			y={Y},{Y2}
		[/move_unit_fake]
		{TAM_REMOVE_IMAGE {X2} {Y2}}
		{PLAY_SOUND water-blast.wav}
		[move_unit_fake]
			side=3
			type="TAM_Cutter"
			x={X2},{X2}
			y={Y2},14
		[/move_unit_fake]
		
		##########################################
		# Complete
		##########################################

		[if]
		{CONDITION subquest_yezza numerical_equals 4}
			[then]
				{TAM_STORE_UNIT side=1 canrecruit=yes ({VARIABLE_OP stored_unit.experience add 50})}
					[floating_text]
						[filter]
							side=1
							canrecruit=yes
						[/filter]
						text="<span color='{TAM_WHITE}'>" + _ "float^+50xp" + "</span>"
					[/floating_text]
					{TAM_STORE_UNIT side=2 canrecruit=yes ({VARIABLE_OP stored_unit.experience add 50})}
					[floating_text]
						[filter]
							side=2
							canrecruit=yes
						[/filter]
						text="<span color='{TAM_WHITE}'>" + _ "float^+50xp" + "</span>"
					[/floating_text]
					# This does nothing other than ensure they level if they exceed their max xp
					{TAM_MODIFY_MAX_EXPERIENCE side=1 canrecruit=yes 0}
					{TAM_MODIFY_MAX_EXPERIENCE side=2 canrecruit=yes 0}
			[/then]
		[/if]
		
	[/event]
	
#enddef

