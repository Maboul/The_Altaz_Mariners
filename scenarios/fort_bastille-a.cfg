#textdomain wesnoth-The_Altaz_Mariners

[scenario]
	id=fort_bastille-a
	name="Fort Bastille"
	map_data="{~add-ons/The_Altaz_Mariners/maps/fort_bastille.map}" 
	random_start_time="no"
	turns=-1  
	experience_modifier=150
	victory_when_enemies_defeated=no
	allow_new_game=no
	force_lock_settings=yes
	{DEFAULT_SCHEDULE}
	{MOOD_CALM}
	
	####################################################################################
	# Side Defintions
	####################################################################################
	
	[side]
		side=1
		canrecruit=yes
		name=Largo
		id=Largo
		save_id=Largo
		controller=human
		team_name=mariners
		user_team_name= _ "Mariners"
		team_lock=yes
		share_vision=all
		gold=0
		village_gold=0
		income=-2
		type=Thug
		fog=no
		shroud=no
	[/side]

	[side]
		side=2
		canrecruit=yes
		name=Hugo
		id=Hugo
		save_id=Hugo
		controller=human
		team_name=mariners
		user_team_name= _ "Mariners"
		team_lock=yes
		share_vision=all
		gold=0
		village_gold=0
		income=-2
		type=Poacher
		fog=no
		shroud=no
	[/side]
	
	[side]
		side=3
		controller=ai
		no_leader=yes
		allow_player=no
		team_name=mariners,foes
		user_team_name= _ "Friends"
		team_lock=yes
		fog=yes
		shroud=yes
		share_vision=all
	[/side]
	
	[side]
		side=4
		controller=ai
		team_name=foes
		user_team_name= _ "Foes"
		team_lock=yes
		allow_player=no
		disallow_observers=yes
		no_leader=yes
		fog=yes
		shroud=yes
		[ai]
			ai_algorithm=idle_ai
		[/ai]
	[/side]
	
	####################################################################################
	# Objectives
	####################################################################################

    [event]
    name=prestart
        [objectives]
            side=0
            [objective]
                description=_ "Investigate the island"
                condition=win
            [/objective]
            [objective]
                description=_ "Mariners move adjacent to an enemy"
                condition=lose
            [/objective]
        [/objectives]
        {VARIABLE scenario fort_bastille}
    [/event]
    
    {PLACE_IMAGE items/gohere.png 35 18}
    
	# Normal exit point
	[event]
		name=moveto
		[filter]
			x=35
			y=18
			side=1,2
		[/filter]
		[if]
			{CONDITION new_ship not_equals yes}
			[then]
				[remove_item]
					x,y=35,18
				[/remove_item]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario=meta-map
				[/endlevel]
			[/then]
		[/if]
	[/event]
	
	# Galleon exit point
	[event]
		name=moveto
		[filter]
			x=36
			y=19
			side=1,2
		[/filter]
		[if]
			{CONDITION new_ship equals yes}
			{CONDITION ship_type equals TAM_Galleon}
			[then]
				[remove_item]
					x,y=$x1,$y1
				[/remove_item]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario=meta-map
				[/endlevel]
			[/then]
		[/if]
	[/event]
	
	# Dhow exit point
	[event]
		name=moveto
		[filter]
			x=41
			y=20
			side=1,2
		[/filter]
		[if]
			{CONDITION new_ship equals yes}
			{CONDITION ship_type equals TAM_Dhow}
			[then]
				[remove_item]
					x,y=$x1,$y1
				[/remove_item]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario=meta-map
				[/endlevel]
			[/then]
		[/if]
	[/event]
	
	# Caravel exit point
	[event]
		name=moveto
		[filter]
			x=43
			y=21
			side=1,2
		[/filter]
		[if]
			{CONDITION new_ship equals yes}
			{CONDITION ship_type equals TAM_Caravel}
			[then]
				[remove_item]
					x,y=$x1,$y1
				[/remove_item]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario=meta-map
				[/endlevel]
			[/then]
		[/if]
	[/event]
	
	# Frigate exit point
	[event]
		name=moveto
		[filter]
			x=45
			y=22
			side=1,2
		[/filter]
		[if]
			{CONDITION new_ship equals yes}
			{CONDITION ship_type equals TAM_Frigate}
			[then]
				[remove_item]
					x,y=$x1,$y1
				[/remove_item]
				[endlevel]
					result=victory
					continue_no_save=yes
					replay_save=no
					carryover_percentage=100
					carryover_report=no
					bonus=no
					linger_mode=no
					next_scenario=meta-map
				[/endlevel]
			[/then]
		[/if]
	[/event]
	
	####################################################################################
	# Intro
	####################################################################################
	
	[event]
		name=start
		[if]
			{CONDITION subquest_serpent numerical_equals 4}
			[then]
				{VARIABLE subquest_serpent 5}
			[/then]
		[/if]
		[if]
			{CONDITION fort_bastille_intro equals yes}
			[then]
				[message]
					speaker=Largo
					message=_ "Remember, stay out of the way of the watchmen."
				[/message]
			[/then]
		[/if]
		[if]
			{CONDITION fort_bastille_intro not_equals yes}
			[then]
				[message]
					speaker=Hugo
					message=_ "Just like old times brother! The royals don't even know we're here."
				[/message]
				[message]
					speaker=Largo
					message=_ "Let's keep it that way and avoid the guards. Any one of them could recognize us."
				[/message]
				[message]
					speaker=Hugo
					message=_ "They'll never notice. We'll just talk to the locals, trade some bounty and slink away."
				[/message]
				{VARIABLE fort_bastille_intro yes}
			[/then]
		[/if]
		[if]
			[have_unit]
				side=1,2
				[filter_wml]
					[modifications]
						[trait]
							id=follower
						[/trait]
					[/modifications]
				[/filter_wml]
			[/have_unit]
			[then]
				[store_unit]
					[filter]
						side=1,2
						[filter_wml]
							[modifications]
								[trait]
									id=follower
								[/trait]
							[/modifications]
						[/filter_wml]
					[/filter]
					variable=stored_unit
				[/store_unit]
				[message]
					speaker=Largo
					message=_ "$stored_unit.name|, you and the others better stay on the ship. We don't want to attract attention."
				[/message]
				[unstore_unit]
					variable=stored_unit
				[/unstore_unit]
				{CLEAR_VARIABLE stored_unit}
			[/then]
		[/if]
	[/event]
	
	####################################################################################
	# Placing Units
	####################################################################################
	
	[event]
    name=prestart
		{TAM_PLACE_FOLLOWERS_ON_SHIP}
		# Royal
		{TAM_PLACE_LEADER 4 General 38 6 "General Leo" {TRAIT_AGED}{TRAIT_INTELLIGENT}}
		{GENERIC_UNIT 4 Swordsman 41 7}
		{GENERIC_UNIT 4 Swordsman 35 7}
		{GENERIC_UNIT 4 Bowman 45 7}
		{GENERIC_UNIT 4 Spearman 32 15}
		{GENERIC_UNIT 4 Spearman 44 15}
		{GENERIC_UNIT 4 Pikeman 34 10}
		{GENERIC_UNIT 4 Spearman 43 9}
		{GENERIC_UNIT 4 Spearman 33 9}
		{GENERIC_UNIT 4 "Heavy Infantryman" 30 14}
		{GENERIC_UNIT 4 "Shock Trooper" 42 10}
		{GENERIC_UNIT 4 Bowman 39 11}
		{GENERIC_UNIT 4 "Longbowman" 45 12}
		{GENERIC_UNIT 4 "Javelineer" 37 11}
		{GENERIC_UNIT 4 Spearman 32 4}
		{GENERIC_UNIT 4 Spearman 44 4}
		# NPCs
		{TAM_PLACE_NPC 3 TAM_Civilian 44 18 Danielo}
		{TAM_PLACE_NPC 3 TAM_Civilian 27 16 Cassel}
		{TAM_PLACE_NPC 3 TAM_Nobleman 28 6 Gordy}
		{TAM_PLACE_NPC 3 TAM_Civilian 46 16 Reksel}
		{TAM_PLACE_NPC 3 TAM_Civilian 31 12 Fraton}
		{TAM_PLACE_NPC 3 TAM_Civilian 46 8 Redmond}
		{TAM_PLACE_NPC 3 TAM_Civilian 34 13 Jessip}
		[+unit]
			profile=portraits/humans/footpad.png
		[/unit]
		{TAM_PLACE_NPC 3 TAM_Nobleman 46 5 Oswald} 
		{TAM_PLACE_NPC 3 "TAM_Dwarvish Sailor" 42 14 "Jimmy James"}
		{TAM_PLACE_NPC 3 Sergeant 37 16 "Customs Agent"}
		{TAM_PLACE_NPC 3 Spearman 31 7 Percival}
		{TAM_PLACE_NPC 3 (TAM_Brute) 49 7 Andok}
		# Characters
		#{TAM_PLACE_NPC 3 "Orcish Slayer" 35 12 "Orc Diplomat"}
		#{TAM_PLACE_NPC 3 "Dwarvish Stalwart" 42 14 "Dwarven Merchant"}
		{TAM_PLACE_NPC 3 Trapper 38 12 Hike}
		
		[if]
			{CONDITION subquest_darcus less_than 3}
			[then]
				{TAM_PLACE_NPC 3 "White Mage" 43 12 "Brother Darcus"}
			[/then]
		[/if]
		
		{TAM_PLACE_NPC 3 TAM_Buccaneer 38 19 "Captain Athos"}
		[+unit]
			profile=portraits/Athos.png
		[/unit]
		# Generic units
		{GENERIC_UNIT 3 (TAM_Brute) 30 15} 
		{GENERIC_UNIT 3 (Ruffian) 36 5} 
		{GENERIC_UNIT 3 (Ruffian) 28 10} 
		{GENERIC_UNIT 4 (Bowman) 49 16}
		# Ships
		{GENERIC_UNIT 3 (TAM_Dhow) 40 20}
		[+unit]
			facing=se
		[/unit]
		{GENERIC_UNIT 3 (TAM_Caravel) 42 21}
		[+unit]
			facing=se
		[/unit]
		{GENERIC_UNIT 3 (TAM_Frigate) 44 22}
		[+unit]
			facing=se
		[/unit]
		{GENERIC_UNIT 3 (TAM_Galleon) 37 20}
		[+unit]
			facing=se
		[/unit]
    [/event]
    
	####################################################################################
	# Placing Images
	####################################################################################
	
	{TAM_PLACING_PLAYER_VESSEL 34 18}
	{TAM_DISEMBARKING_VESSEL (side=1,2) (x,y=5,2) 34 18}
    {TAM_BOARDING_VESSEL side=1,2 x,y=34,18}
    
	[event]
	name=prestart
		# Shops	
		{PLACE_IMAGE scenery/tent-fancy-red.png 36 12}
		{PLACE_IMAGE scenery/tent-shop-weapons.png 39 14}
		{PLACE_IMAGE scenery/tent-shop-weapons.png 44 13}
		# Scenery
		{PLACE_IMAGE scenery/fishbox.png 32 5}
		{PLACE_IMAGE scenery/fishbox.png 46 12}
		{PLACE_IMAGE scenery/leanto.png 47 5}
		{PLACE_IMAGE scenery/leanto.png 28 5}
		{PLACE_IMAGE items/straw-bale1.png 27 7}
		{PLACE_IMAGE items/dummy.png 40 5}
		{PLACE_IMAGE items/scarecrow.png 29 5}
		{PLACE_IMAGE items/box.png 27 15}
		{PLACE_IMAGE items/box.png 42 5}
		{PLACE_IMAGE items/archery-target-right.png 49 15}
		{PLACE_IMAGE items/chest-plain-closed.png 30 13}
		{PLACE_IMAGE items/barrel.png 43 16}
		{PLACE_IMAGE items/chest-plain-closed.png 30 13}
		{PLACE_IMAGE items/box.png 43 17}
		{PLACE_IMAGE units/ships/cutter.png 46 19}
		[if]
			{CONDITION figurehead_halberdier not_equals yes}
			[then]
				{PLACE_IMAGE scenery/figureheads/halberdier-statue.png 38 8}
			[/then]
		[/if]
		[if]
			{CONDITION subquest_moira less_than 4}
			[then]
				{PLACE_IMAGE items/cauldron.png 48 6}
			[/then]
		[/if]

	[/event]
	
	####################################################################################
	# Events
	####################################################################################
	
	{TAM_GLOBAL_EVENTS}
	{TAM_TRADING_PORT 35 15 bastille (scenery/tent-ruin-1.png)}
	{TAM_TAVERN 40 12 scenery/tavern.png}
	#{TAM_BANK 38 8 scenery/temple1.png}
	
	# Prevent ships from moving
	[event]
	name="side turn"
	first_time_only=no
		{TAM_STORE_UNITS race=vessel side=$side_number ({VARIABLE stored_units[$i].moves 0})}
	[/event]
	
	# Defeat
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                side=4
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=General Leo
			message=_ "Guards, seize them!"
		[/message]
		[message]
			speaker=unit
			message=_ "Damn."
		[/message]
		[endlevel]
			result=defeat
		[/endlevel]
	[/event]
	
	##########################################
	# The Shovel
	##########################################
	
	[event]
    name=prestart
		[filter_condition]
			{CONDITION inventory.shovel not_equals 1}
			{CONDITION random_island_2720 equals reef_town}
		[/filter_condition]
		
		{PLACE_IMAGE items/shovel.png 48 16}
		
		{RANDOM 1..100}
		# Nothing (40%)
		[if]
			{CONDITION random less_than_equal_to 40}
			[then]
			[/then]
		[/if]
		# Absent (60%)
		[if]
			{CONDITION random greater_than 40}
			{CONDITION random less_than_equal_to 100}
			[then]
				[kill]
					side=4
					animate=no
					x,y=49,16
				[/kill]
			[/then]
		[/if]
		{CLEAR_VARIABLE random}
	[/event]
	
	[event]
		name=moveto
		[filter]
			side=1,2
			canrecruit=yes
			x,y=48,16
			[not]
				[filter_adjacent]
					side=4
				[/filter_adjacent]
			[/not]
		[/filter]
		[filter_condition]
			{CONDITION inventory.shovel not_equals 1}
			{CONDITION random_island_2720 equals reef_town}
		[/filter_condition]
		{VARIABLE inventory.shovel 1}
		{TAM_REMOVE_IMAGE 48 16}
		{PLAY_SOUND skeleton-hit-2.ogg}
		{TAM_ITEM_ADDED}
	[/event]
	
	##########################################
	# The Statue
	##########################################
	
	[event]
		name=moveto
		[filter]
            side=1,2
			#canrecruit=yes
            x,y=38,8
        [/filter]
        [filter_condition]
			{CONDITION figurehead_halberdier not_equals yes}
        [/filter_condition]
        [message]
			side=$side_number
			canrecruit=yes
			message=_ "Some royal hero, I guess. It would tickle me to swag it and use it as a figurehead on the ship. Worth it to see their faces when they clock it coming full sail at them."
		[/message]
		[message]
			speaker=unit
			message=_ "Let's see if it comes loose..."
		[/message]
		[message]
			side=4
			type=Javelineer
			message=_ "What are you doing?"
		[/message]
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			
			# Admire
			[option]
				description=_ "<span color='{TAM_BLUE}'>Pretend to admire the statue</span>"
				[command]
					[message]
						speaker=unit
						message=_ "Just looking. He cuts a fine figure, don't you think?"
					[/message]
					[message]
						side=4
						type=Javelineer
						message=_ "Of course, it's none other than the Champion of Bastille. Anyway, no loitering allowed - get lost!"
					[/message]
					[message]
						speaker=unit
						message=_ "Sorry sir, on my way."
					[/message]
				[/command]
			[/option]

			# Clean
			[option]
				description=_ "<span color='{TAM_BLUE}'>Pretend to be cleaning the statue</span>"
				[command]
					[message]
						speaker=unit
						message=_ "Just giving the hero here a spruce. I'm under cleaning orders from the guv'nor."
					[/message]
					[message]
						side=4
						type=Javelineer
						message=_ "Very well, but be quick about it."
					[/message]
					[message]
						speaker=narrator
						image=wesnoth-icon.png
						message=_ "You pretend to clean the statue, but the instant the guard looks away you wrench it free and scarper."
					[/message]
					{VARIABLE figurehead_halberdier yes}
					{PLAY_SOUND skeleton-big-hit-1.ogg}
					{PLAY_SOUND mace-miss.ogg}
					{REMOVE_IMAGE $x1 $y1}
					[move_unit]
						x,y=$x1,$y1
						to_x=35
						to_y=17
					[/move_unit]
					[message]
						canrecruit=yes
						side=$side_number
						message=_ "Let's go. Now!"
					[/message]
				[/command]
			[/option]
			
		[/message]
	[/event]
	
	##########################################
	# The  Cauldron
	##########################################
	
	[event]
		name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            x,y=48,6
        [/filter]
        [filter_condition]
			{CONDITION subquest_moira numerical_equals 3}
        [/filter_condition]
        [message]
			speaker=unit
			message=_ "I know someone who would appreciate this cauldron."
		[/message]
		[message]
			speaker=Andok
			message=_ "Yes, me! Please stop eyeing up my property."
		[/message]
	[/event]
	
	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=1,2
			canrecruit=yes
			x,y=48,6
		[/filter]
		[filter_condition]
			{CONDITION subquest_moira numerical_equals 3}
		[/filter_condition]
		[store_side]
			side=$side_number
			variable=shopper
		[/store_side]
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			
			# Steal
			[option]
				description=_ "<span color='{TAM_BLUE}'>Steal the cauldron</span>"
				[command]
					[message]
						speaker=unit
						message=_ "I'm taking this cauldron. Don't try to stop me..."
					[/message]
					[message]
						speaker=Andok
						message=_ "Hang on, what?"
					[/message]
					
					[if]
						{CONDITION unit.name equals Largo}
						[then]
							[message]
								side=$side_number
								canrecruit=yes
								id=Largo
								message=_ "Make another noise and I'll cave in your skull."
							[/message]
						[/then]
						[else]
							[message]
								side=$side_number
								canrecruit=yes
								id=Hugo
								message=_ "Make another noise and I'll slit your throat."
							[/message]
						[/else]
					[/if]
					[message]
						speaker=Andok
						message=_ "..."
					[/message]
					[remove_item]
						x,y=48,6
						image=items/cauldron.png
					[/remove_item]
					{VARIABLE subquest_moira 4}
					{VARIABLE_OP inventory.cauldron add 1}
					{TAM_ITEM_ADDED}
				[/command]
			[/option]
			
			# Buy
			[option]
				description=_ "<span color='{TAM_BLUE}'>Offer to buy it for 20g</span>"
				[show_if]
					{CONDITION shopper.gold greater_than_equal_to 20}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "How about I buy it off you for twenty coins?"
					[/message]
					[message]
						speaker=Andok
						message=_ "What, this hulk of iron? Sure..."
					[/message]
					[remove_item]
						x,y=48,6
						image=items/cauldron.png
					[/remove_item]
					{VARIABLE subquest_moira 4}
					{VARIABLE_OP inventory.cauldron add 1}
					{TAM_GOLD $side_number -20}
					{TAM_ITEM_ADDED}
				[/command]
			[/option]
			
		[/message]
	[/event]
	
	[event]
		name=moveto
		[filter]
			side=1,2
			canrecruit=yes
			[filter_adjacent]
				id=Andok
			[/filter_adjacent]
		[/filter]
		[filter_condition]
			{CONDITION subquest_moira greater_than_equal_to 5}
		[/filter_condition]
		[message]
			speaker=Andok
			message=_ "Hey, aren't you the guy who..."
		[/message]
		[message]
			speaker=unit
			message=_ "Nope. I've never met you before and I'd like to keep it that way."
		[/message]
		[message]
			speaker=Andok
			message=_ "Whatever, mister."
		[/message]
	[/event]
	
	####################################################################################
	# Dialogue
	####################################################################################
	
	#[event]
	#name=moveto
	#	[filter]
     #       side=1,2
      #      canrecruit=yes
      #      [filter_adjacent]
        #        id=Hike
        #    [/filter_adjacent]
  	#	[/filter]
	#	[message]
	#		speaker=Hike
	#		message=_ "I'm afraid all the shops are shut at the moment. You'll have to wait for the next release for them to open."
	#	[/message]
	#[/event]
		
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Reksel
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Reksel
			message=_ "They say the brotherhood and sisterhood are at odds. Imagine that, men and women fighting!"
		[/message]
	[/event]
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Redmond
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Redmond
			message=_ "Word is, two murdering maniacs escaped from the island gaol. Don't worry though, the royals have half the navy looking for them."
		[/message]
	[/event]
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Gordy
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Jordy
			message=_ "You look just like the man who robbed me. If I ever catch that rogue..."
		[/message]
	[/event]
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Cassel
            [/filter_adjacent]
  		[/filter]
  		[if]
			{CONDITION farrow equals a}
			[then]
				[message]
					speaker=Cassel
					message=_ "Some fool tried tellin' me there's a civil war in Farrow. Who believes such nonsense? Baron Lothar rules with an iron fist!"
				[/message]
			[/then]
			[else]
				[message]
					speaker=Cassel
					message=_ "Some fool tried tellin' me Baron Lothar was toppled by an uprising on Farrow. Who believes such nonsense?"
				[/message]
			[/else]
		[/if]
	[/event]
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Peddler
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Peddler
			message=_ "Wolf pelts, rabbit furs and animal traps. Step right up."
		[/message]
	[/event]

	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Dwarven Merchant
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Dwarven Merchant
			message=_ "Axes, hammers and shields! All the finest dwarven goods, all the way from Westchire Mines. Smithed in real dwarven forges."
		[/message]
	[/event]

	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Customs Agent
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Customs Agent
			message=_ "No blades, no bows. Keep your weapons sheathed. Move along."
		[/message]
	[/event]

	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=General Leo
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=General Leo
			message=_ "Move along citizen."
		[/message]
	[/event]

	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Fraton
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker=Graton
			message=_ "Hello mate."
		[/message]
	[/event]
	
	##########################################
	# Jimmy James
	##########################################
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id="Jimmy James"
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker="Jimmy James"
			message=_ "Ahoy!"
		[/message]
	[/event]
	
	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=1,2
			canrecruit=yes
			[filter_adjacent]
				id="Jimmy James"
			[/filter_adjacent]
		[/filter]

		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			
			# Pleasantries
			[option]
				description=_ "<span color='{TAM_BLUE}'>Exchange pleasantries</span>"
				[command]
					[message]
						speaker=unit
						message=_ "How you doing, Jimmy?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Well, well. I heard you two had been locked away..."
					[/message]
					[message]
						speaker=unit
						message=_ "Keep your voice down, Jimmy. It ain't the safest place to be telling pirate stories."
					[/message]
				[/command]
			[/option]
			
			# Ask if he'll join you
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask if he'll join you</span>"
				[command]
					[message]
						speaker=unit
						message=_ "You fancy riding the waves again, Jimmy? We could use a good blacksmith on board."
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Nah, metal is yesterday's game. I'm a trader now and I'm making plenty just sitting on my backside right here."
					[/message]
				[/command]
			[/option]
			
			# Ask about trading
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask for trading advice</span>"
				[command]
					[message]
						speaker=unit
						message=_ "Tell me about trading - how'd you get started?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Well, if truth be told I made me a mint running spices to Greystone. They don't see much of it down there cos it all flows out of Dahazi these days. But it's the other way round when it comes to rum. Whatever the cargo you'll get a better price the further you ship it. You put in the distance, you earn the crust."
					[/message]
				[/command]
			[/option]
			
			# Ask about the sea monster
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask if knows anything about the sea monster</span>"
				[show_if]
					{CONDITION subquest_serpent numerical_equals 1}
					[or]
						{CONDITION subquest_serpent numerical_equals 2}
					[/or]	
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Heard any rumours about a sea monster?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Aye, I used to sail with Captain Anthony. He was obsessed with finding that damn monster. Heck, the entire crew was giddy at the prospect. We'd sailed for months near Elixion, praying for a clue. No luck!"
					[/message]
				[/command]
			[/option]
			
			# Mention the sea monster
			[option]
				description=_ "<span color='{TAM_BLUE}'>Mention the sea monster</span>"
				[show_if]
					{CONDITION subquest_serpent numerical_equals 4}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Did you hear about the sea monster we ran into?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Is it true you found the serpent? Old Mike Anthony was driven mad by the search. In the end I chalked it up as a fool's fancy!"
					[/message]
				[/command]
			[/option]
			
			# Ask about the ankh
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the missing ankh</span>"
				[show_if]
					{CONDITION subquest_darcus numerical_equals 1}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Know anything about Brother Darcus' missing ankh?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Nah, but I bet someone down at Greystone does. Plenty o' cutpurses holed up in that place."
					[/message]
				[/command]
			[/option]
			
			# Ask about the southern storm
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the southern storm</span>"
				[show_if]
					{CONDITION log_storm.seen equals yes}
					{CONDITION log_storm.heard_rumour not_equals yes}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "What do you know about this storm in the south?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "I ain't been sailing that way in a while. You best be asking Athos about that."
					[/message]
				[/command]
			[/option]
			
			# Show him the gold armour
			[option]
				description=_ "<span color='{TAM_BLUE}'>Show him the golden armour</span>"
				[show_if]
					{CONDITION random_island_2720 equals thurh_gar}
					{CONDITION inventory.armour greater_than_equal_to 1}
				[/show_if]
				[command]
						[message]
							speaker=unit
							message=_ "You still doing any smithing these days? I got hold of some fancy golden armour..."
						[/message]
						[message]
						speaker="Jimmy James"
						message=_ "Nah, I hung up my tongs a while back. You best take it down to Thurh Gah and get Dharmok to have a look."
					[/message]
				[/command]
			[/option]
			
			# Show him the gold armour (if Thur Gar doesn't exist)
			[option]
				message=_ "<span color='{TAM_BLUE}'>Show him the golden armour</span>"
				[show_if]
					{CONDITION inventory.armour greater_than_equal_to 1}
					#{CONDITION subquest_gaddon numerical_equals 2}
					{CONDITION random_island_2720 not_equals thurh_gar}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "You dwarves know your metals... what do you make of this golden armour?"
					[/message]
					[message]
						speaker="Jimmy James"
						message=_ "Looks decent enough. I'll take it off your hands for fifty coins, for old time's sake. I can probably patch it up and find a buyer at the docks."
					[/message]
					[message]
						speaker=unit
						message=_ "Let me think about it."
					[/message]
					#{VARIABLE subquest_gaddon 3}
				[/command]
			[/option]
			
			# Sell him the gold armour
			[option]
				message=_ "<span color='{TAM_BLUE}'>Sell him the golden armour</span>"
				[show_if]
					{CONDITION inventory.armour greater_than_equal_to 1}
					#{CONDITION subquest_gaddon numerical_equals 3}
					{CONDITION random_island_2720 not_equals thurh_gar}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Here, the armour is yours."
					[/message]
					{VARIABLE_OP inventory.armour add -1}
					#{VARIABLE subquest_gaddon 4}
					{TAM_GOLD $side_number 50}
					{PLAY_SOUND gold.ogg}
					[floating_text]
						x,y=$x1,$y1
						text="<span color='{TAM_GOLDEN}'>" + _ "float^50g" + "</span>"
					[/floating_text]
				[/command]
			[/option]
			
		[/message]
	[/event]
	
	##########################################
	# Captain Athos
	##########################################
		
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Captain Athos
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker="Captain Athos"
			message=_ "Good day."
		[/message]
	[/event]
	
	[event]
	name=moveto
	first_time_only=no
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Captain Athos
            [/filter_adjacent]
  		[/filter]
	
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			
			# Ask what he does
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask what he does here</span>"
				[command]
					[message]
						speaker=unit
						message=_ "What is it you do here, Athos?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "I'm a merchant, a trader. I supply the royal ports with the goods the king cannot readily find in his own lands."
					[/message]
					[message]
						speaker=unit
						message=_ "Do you sail under the flag of the Royal Navy?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "No, not quite. I'm my own boss. I'm no great fan of King Tylon, but his officers pay me well to fetch what his kingdom requires. That is all."
					[/message]
				[/command]
			[/option]
			
			# Enquire about business (pre-quest)
			[option]
				description=_ "<span color='{TAM_BLUE}'>Enquire about business</span>"
				[show_if]
					{CONDITION subquest_serpent equals 0}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "How's business, Athos?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Not great, why do you ask?"
					[/message]
					[message]
						speaker=unit
						message=_ "What's up? Maybe we could lend a hand. We're always scouting for work, if it pays."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "You look able enough. Spent much time on the open sea?"
					[/message]
					[message]
						speaker=unit
						message=_ "More than my share. The sea is what I call home."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Ha, is that so? I may have some work for you."
					[/message]
				[/command]
			[/option]
			
			# Enquire about business (post-quest)
			[option]
				description=_ "<span color='{TAM_BLUE}'>Enquire about business</span>"
				[show_if]
					{CONDITION subquest_serpent numerical_equals 5}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "How goes it, Athos?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Ah, welcome back. Trade has been slow to pick up, but at least the ships are reaching us in one piece now. I fear the rumours of the sea monster will linger for many moons yet..."
					[/message]
					[message]
						speaker=unit
						message=_ "Well, it does make a fine yarn."
					[/message]
				[/command]
			[/option]
					
			# Ask if he has any work
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask if he has any work</span>"
				[show_if]
					{CONDITION subquest_serpent equals 0}
				[/show_if]
				[command]
					[message]
						speaker="Captain Athos"
						message=_ "In the last year two of my cargo ships have vanished whilst sailing through the western waters. Such a loss has almost crippled my business."
					[/message]
					[message]
						speaker=unit
						message=_ "Did they fall prey to pirates? I've heard there are many murderous men upon the waves."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "No, this was not the work of pirates. You see, last week one of my crewmen found his way back here. He was on board the second of the ships to disappear. In the end, he did not fare much better than the rest."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "My man was feverish and died the morning after he arrived. He spent the night mouthing strange mutterings, words I took to be garbled clues as to the fate of his fellow crewmen. In short, I believe there to be a great monster in those seas. A beast large enough to break the bows of boats. My boats."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "I requested the help of the Royal Navy, but their petty captains merely laughed at the notion of such a thing."
					[/message]
					[message]
						speaker=unit
						message=_ "It is not a notion one warms to."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "I know it is a tall order, but I need that sea to be safe. I cannot risk more ships going under. You will be richly rewarded if you manage to find this creature - and kill it."
					[/message]
					[message]
						speaker=unit
						message=_ "If we see anything we will report back. But I can't promise we'll find this monster of yours."
					[/message]
					{VARIABLE subquest_serpent 1}
				[/command]
			[/option]
			
			# Ask about the sea monster (pre-quest)
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the sea monster</span>"
				[show_if]
					{CONDITION subquest_serpent equals 1}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "About this sea monster, Athos."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Have you found it? Excellent! I knew I..."
					[/message]
					[message]
						speaker=unit
						message=_ "No, we're still looking."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "This is the wrong place to be looking."
					[/message]
				[/command]
			[/option]
			
			# Tell the tale (escape)
			[option]
				description=_ "<span color='{TAM_BLUE}'>Tell him about the serpent</span>"
				[show_if]
					{CONDITION subquest_serpent equals 2}
				[/show_if]
				[command]
					[message]
						speaker="Captain Athos"
						message=_ "Ah, you return! Something tells me you are ready to believe my tale now, eh?"
					[/message]
					[message]
						speaker=unit
						message=_ "Yes, we found the creature you spoke of."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "And it has perished?"
					[/message]
					[message]
						speaker=unit
						message=_ "It was us who nearly perished, the creature lives."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "This is a shame."
					[/message]
					[message]
						speaker=unit
						message=_ "We were eaten alive, Athos! That we managed to escape is a miracle enough."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "I see. Such a tale would seem incredible, were it not for the one that preceded it. Nevertheless, a confirmed sighting might be the thing to stir those damn royals into action. Though you failed in what I asked, I feel duty bound to give some reward for your... troubles."
					[/message]
					[message]
						speaker=unit
						message=_ "You are an honourable soul, captain."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Take this purse of 70 gold and let us hope your next voyage is less eventful."
					[/message]
					{VARIABLE subquest_serpent 4}
					{TAM_GOLD $side_number 70}
					{PLAY_SOUND gold.ogg}
					[floating_text]
						x,y=$x1,$y1
						text="<span color='{TAM_GOLDEN}'>" + _ "float^70g" + "</span>"
					[/floating_text]
				[/command]
			[/option]
			
			# Tell the tale (death)
			[option]
				description=_ "<span color='{TAM_BLUE}'>Tell him about the serpent</span>"
				[show_if]
					{CONDITION subquest_serpent equals 3}
				[/show_if]
				[command]
					[message]
						speaker="Captain Athos"
						message=_ "Ah, you return! Something tells me you are ready to believe my tale now, eh?"
					[/message]
					[message]
						speaker=unit
						message=_ "Yes, we found the creature you spoke of."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "And it has perished?"
					[/message]
					[message]
						speaker=unit
						message=_ "Aye, but it was no small endeavour. We were swept from our ship into its very belly! I hope this errand of yours pays well."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Such a tale would seem incredible, were it not for the one that preceded it. I am pleased that you have lived to tell it. You shall indeed be rewarded."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Now tell me, what do you make of this galleon behind me? Or would you prefer a sack of gold. Say, two hundred pieces?"
					[/message]
					{VARIABLE subquest_serpent 4}
					[message]
						speaker=narrator
						image=wesnoth-icon.png
						message= _ "What will you do?"
						
						# Gold
						[option]
							description=_ "<span color='{TAM_BLUE}'>Take the gold</span>"
							[command]
								[message]
									speaker=unit
									message=_ "We'll take the gold, thanks."
								[/message]
								[message]
									speaker="Captain Athos"
									message=_ "Very well. It is a pleasure to have done business with you."
								[/message]
								{TAM_GOLD $side_number 200}
								{PLAY_SOUND gold.ogg}
								[floating_text]
									x,y=$x1,$y1
									text="<span color='{TAM_GOLDEN}'>" + _ "float^200g" + "</span>"
								[/floating_text]
							[/command]
						[/option]
						
						# Galleon
						[option]
							description=_ "<span color='{TAM_BLUE}'>Take the galleon</span>"
							[command]
								[message]
									speaker=unit
									message=_ "The galleon would make a fine reward."
								[/message]
								[message]
									speaker="Captain Athos"
									message=_ "Very well, it is yours."
								[/message]
								[message]
									speaker=narrator
									image=wesnoth-icon.png
									message= _ "What will you christen your new ship?"
									[text_input]
										variable=ship_name
										label=_ "Type Here: "
										max_chars=50
									[/text_input]
								[/message]
								[message]
									speaker=unit
									message=_ "I christen this ship $ship_name|."
								[/message]
								[remove_item]
									x,y=35,18
								[/remove_item]
								# Remove the other exits in case a ship has been bought
								[remove_item]
									x,y=41,20
								[/remove_item]
								[remove_item]
									x,y=43,21
								[/remove_item]
								[remove_item]
									x,y=45,22
								[/remove_item]
								{VARIABLE ship_type TAM_Galleon}
								{VARIABLE rum_max 6}
								{VARIABLE jewels_max 6}
								{VARIABLE spices_max 6}
								#{TAM_STORE_UNIT race=vessel type=$ship_type (
								#{VARIABLE stored_unit.id $ship_name}
								#{VARIABLE stored_unit.name $ship_name}
								#{VARIABLE stored_unit.side 1}
								#{VARIABLE stored_unit.moves 0}
								#)}
								[kill]
									x,y=37,20
									animate=no
								[/kill]
								[item]
									x,y=37,20
									image=units/ships/galleon.png~TC(1,magenta)
								[/item]
								{HIGHLIGHT_IMAGE 36 19 items/gohere.png misc/blank-hex.png}
								{VARIABLE new_ship yes}
								{VARIABLE finished yes}
							[/command]
						[/option]
						
					[/message]
				[/command]
			[/option]
					
			# Ask about the storm barrier
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask what he knows of the southern storm</span>"
				[show_if]
					{CONDITION log_storm.seen equals yes}
					{CONDITION log_storm.heard_rumour not_equals yes}
					#{CONDITION temple_of_ice equals z}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Athos, you're a man of the sea. Maybe you can help us?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "How so?"
					[/message]
					[message]
						speaker=unit
						message=_ "It is a strange tale. We sailed south for many days and spotted a storm unlike any other. Great heavy clouds hung in the sky. Seemed like it would never blow over."
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Yes, I have seen this sight myself. It is a damnable thing. You are right in thinking it is not quick to pass. I have been expecting a shipment from the outlying lands and it is now several weeks late."
					[/message]
					[message]
						speaker=unit
						message=_ "Know you what could cause such a gale?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "I do not, but would dearly like to. Some of my sailors have their hunches of course. I've heard them speak of the Brotherhood of Ice. I've followed it up with royal officials, but it has got me nowhere."
					[/message]
					{VARIABLE log_storm.heard_rumour yes}
				[/command]
			[/option]
			
			# Ask him to join you (war)
			[option]
				message=_ "<span color='{TAM_BLUE}'>Ask if he will join you</span>"
				[show_if]
					{CONDITION fort_liberty not_equals z}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Athos, we are making our move on Fort Liberty. Do we have your backing?"
					[/message]
					[message]
						speaker="Captain Athos"
						message=_ "Cease this careless talk! I cannot be heard discussing treason with a couple of pirates. Keep your voices down and I'll refrain from alerting the guards. That is all the support I can offer."
					[/message]
				[/command]
			[/option]
				
		[/message]
	[/event]

	##########################################
	# Percival
	##########################################
	
	[event]
	name=moveto
	first_time_only=no
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id="Percival"
                side=3
            [/filter_adjacent]
  		[/filter]
		
		[if]
		{CONDITION subquest_blade numerical_equals 2}
			[then]
				[message]
					speaker=Percival
					message=_ "Has the Crow landed?"
				[/message]
				[message]
					speaker=unit
					message=_ "Um, I guess so. We've got this scroll for you."
				[/message]
				[message]
					speaker=Percival
					message=_ "Shhh, now leave quietly. The Crow is waiting."
				[/message]
				{VARIABLE subquest_blade 3}
				{CLEAR_VARIABLE inventory.scroll_crow}
			[/then]
		[/if]
		[if]
		{CONDITION subquest_blade numerical_equals 4}
			[then]
				[message]
					speaker=unit
					message=_ "Crow is dead."
				[/message]
				[message]
					speaker=Percival
					message=_ "Sorry, do I know you?"
				[/message]
			[/then]
		[/if]
	[/event]
		
	##########################################
	# Brother Darcus
	##########################################
	
	# If the player is cursed
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
			ability=tam_curse_morteau
			[filter_adjacent]
				id="Brother Darcus"
				side=3
			[/filter_adjacent]
  		[/filter]
		[message]
			speaker="Brother Darcus"
			message=_ "You have an ungodly curse upon you! Stay back!"
		[/message]
	[/event]	
	
	# Initial dialogue	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [not]
				ability=tam_curse_morteau
            [/not]
            [filter_adjacent]
                id="Brother Darcus"
                side=3
            [/filter_adjacent]
  		[/filter]
		[message]
			speaker="Brother Darcus"
			message=_ "Greetings friend. You have a weary look about you. Tell me, have you seen the light?"
		[/message]
	[/event]	
	
	# Thereafter
	[event]
		name=moveto
		first_time_only=no
		[filter]
			side=1,2
			canrecruit=yes
			[not]
				ability=tam_curse_morteau
            [/not]
			[filter_adjacent]
				id="Brother Darcus"
				side=3
			[/filter_adjacent]
		[/filter]
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			# Ask about the Brotherhood of Light
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the Brotherhood of Light</span>"
				[show_if]
					{CONDITION subquest_darcus numerical_equals 0}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "What business has the Brotherhood of Light in these parts?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "Our business is to spread the light, thus in dark times our calling takes us far and wide."
					[/message]
					[message]
						speaker=unit
						message=_ "Ha! So you seek to convert the royals?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "Aye, you may laugh. I came here to preach but I was pickpocketed whilst doing so. My holy symbol was taken and now I cannot return to the monastery. If you chance upon it please think of me."
					[/message]
					[message]
						speaker=unit
						message=_ "Sure! And what is this symbol? Is it precious?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "It is an ankh, a symbol of my monastery. It is worthless to all except me, though I daresay the fool who purloined it believed otherwise. It is neither enchanted nor made of anything more valuable than bronze. Nevertheless, he who returns it to me shall be blessed."
					[/message]
					{VARIABLE subquest_darcus 1}
				[/command]
			[/option]
			# Ask about the ankh
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about his ankh</span>"
				[show_if]
					{CONDITION subquest_darcus numerical_equals 1}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Have you found that which was stolen from you?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "Alas, I seek it still, though it is likely the symbol has been whisked to some far off place."
					[/message]
				[/command]
			[/option]
			# Tell him about the ankh
			[option]
				description=_ "<span color='{TAM_BLUE}'>Tell him about his ankh</span>"
				[show_if]
					{CONDITION subquest_darcus equals 1}
					{CONDITION inventory.ankh numerical_equals -1}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "We found your ankh, but I don't think you'll get it back without a fight."
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "You bring bad news. I suppose I am compelled to return without it. Thank you nonetheless."
					[/message]
					{VARIABLE subquest_darcus 4}
				[/command]
			[/option]
			# Return the ankh
			[option]
				description=_ "<span color='{TAM_BLUE}'>Return the ankh</span>"
				[show_if]
					{CONDITION subquest_darcus numerical_equals 1}
					{CONDITION inventory.ankh greater_than_equal_to 1}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "We have found your holy symbol, Darcus. It was in the possession of a student from the Ivory Tower."
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "This is good news, but please spare me the details! I am certain I would not approve."
					[/message]
					[message]
						speaker=unit
						message=_ "Do you approve of, say, a little reward?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "Very well. I knew it would come to this, so I have prepared potions for you both. Drink it now and let the light seep in."
					[/message]
					# HP Boost for Largo
					{PLAY_SOUND potion.ogg}
					{TAM_DELAY 300}
					{TAM_MODIFY_MAX_HITPOINTS side=1 canrecruit=yes 8}
					[floating_text]
						[filter]
							side=1
							canrecruit=yes
						[/filter]
						text="<span color='green'>" + _ "float^+8 Max HP" + "</span>"
					[/floating_text]
					# HP Boost for Hugo
					{TAM_MODIFY_MAX_HITPOINTS side=2 canrecruit=yes 8}
					[floating_text]
						[filter]
							side=2
							canrecruit=yes
						[/filter]
						text="<span color='green'>" + _ "float^+8 Max HP" + "</span>"
					[/floating_text]
					# Set variables
					{CLEAR_VARIABLE inventory.ankh}
					{VARIABLE subquest_darcus 3}
				[/command]
			[/option]
			# Ask about the Brotherhood of Ice
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the Brotherhood of Ice</span>"
				[show_if]
					{CONDITION log_storm.heard_rumour equals yes}
					{CONDITION log_storm.darcus not_equals yes}
					{CONDITION temple_of_ice equals z}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Brother, excuse me. I know this might sound rude, but what do you know about the Brotherhood of Ice?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "They are the most elusive of all the brotherhoods. Their temple is purposefully hidden, though it is believed that the king has some access to their elders."
					[/message]
					[message]
						speaker=unit
						message=_ "Do you know of anyone who has seen their temple?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "Um, yes... there is one who once joined the Brotherhood but did not last his training. His name is Morteau. But he is a very unpleasant and vainglorious character."
					[/message]
					[message]
						speaker=unit
						message=_ "Thank you, maybe we should seek out this Morteau."
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "I do not advise it."
					[/message]
					{VARIABLE log_storm.darcus yes}
				[/command]
			[/option]
			# Ask about The Black Blade
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask him about the Black Blade</span>"
				[show_if]
					{CONDITION subquest_blade greater_than_equal_to 2}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "What do you know of the Black Blade?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "They are bloodthirty thieves, so I am told."
					[/message]
					[message]
						speaker=unit
						message=_ "You don't sound so sure..."
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "I would believe it more readily if the ones who told me were not so bloodthirsty themselves."
					[/message]
					[message]
						speaker=unit
						message=_ "Do you mean the royals?"
					[/message]
					[message]
						speaker="Brother Darcus"
						message=_ "I shall say no more on the matter."
					[/message]
				[/command]
			[/option]
		[/message]
		
	[/event]
	
	##########################################
	# Jessip
	##########################################
	
	[event]
	name=moveto
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Jessip
                side=3
            [/filter_adjacent]
  		[/filter]
  		[message]
			speaker=unit
			message=_ "Anything going on around here?"
		[/message]
  		[message]
			speaker=Jessip
			message=_ "Depends who's asking. A coin might prompt my memory."
		[/message]
	[/event]
	
	[event]
	name=moveto
	first_time_only=no
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Jessip
                side=3
            [/filter_adjacent]
  		[/filter]
  		
  		[store_side]
			side=$side_number
			variable=shopper
		[/store_side]
	
		[message]
			speaker=narrator
			image=wesnoth-icon.png
			message= _ "What will you do?"
			
			# Walk on
			[option]
				description=_ "Walk on"
				[command]
				[/command]
			[/option]
			
			# Pay for info
			[option]
				description=_ "<span color='{TAM_BLUE}'>Give him a gold piece</span>"
				[show_if]
					{CONDITION shopper.gold greater_than_equal_to 1}
					{CONDITION jessip not_equals paid}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Here's your coin..."
					[/message]
					{TAM_GOLD $side_number -1}
					{VARIABLE jessip paid}
					[message]
						speaker=Jessip
						message=_ "So, anything in particular you want to ask me about?"
					[/message]
				[/command]
			[/option]
			
			# Buildings
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the buildings in Fort Bastille</span>"
				[show_if]
					{CONDITION jessip equals paid}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Tell me about the buildings here in Fort Bastille."
					[/message]
					[message]
						speaker=Jessip
						message=_ "Well, you're stood in the market place. There's a few shops here - mainly they sell wares to the sailors passing through. You might want to visit the tavern if you've got an hour or a day to spare."
					[/message]
					[if]
						{CONDITION figurehead_halberdier not_equals yes}
						[then]
							[message]
								speaker=Jessip
								message=_ "Also, you'll see a statue in the centre of the town. It was built to honour some royal hero, though I can't say who he was exactly. Even General Leo probably couldn't tell you."
							[/message]
						[/then]
					[/if]
					[message]
						speaker=Jessip
						message=_ "If you're looking for a new ship, you'd do well to visit the shipyards. Speak with Danielo, he'll sort you out."
					[/message]
					[message]
						speaker=unit
						message=_ "Thanks, Jessip."
					[/message]
				[/command]
			[/option]
			
			# People
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the people of Fort Bastille</span>"
				[show_if]
					{CONDITION jessip equals paid}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Is there anyone in town I should know about?"
					[/message]
					[message]
						speaker=Jessip
						message=_ "Hmm, let me see. General Leo oversees this port. He was once highly revered round here, but the king shamed him. Stripped him of battle honours, they say. Now he's stuck with magistrate duties."
					[/message]
					[if]
						{CONDITION subquest_darcus less_than 3}
						[then]
							[message]
								speaker=Jessip
								message=_ "There's also Brother Darcus. He's an envoy from the Brotherhood of Light. He's nice enough, but you'd better watch your tongue with him. He's here to save our souls, and that means no cursing!"
							[/message]
							[message]
								speaker=unit
								message=_ "Sounds like an idiot. Anyone else?"
							[/message]
						[/then]
						[else]
							[message]
								speaker=Jessip
								message=_ "Brother Darcus used to be stationed here, but he left to return to his monastery. Things seem to be getting worse these days without his calming influence."
							[/message]
						[/else]
					[/if]
					[message]
						speaker=Jessip
						message=_ "You'll also find Captain Athos down at the docks. He's kind of a big shot around here. Owns a couple of merchant ships and does a good trade in foreign goods."
					[/message]
				[/command]
			[/option]
			
			# Black Blade
			[option]
				description=_ "<span color='{TAM_BLUE}'>Ask about the Black Blade</span>"
				[show_if]
					{CONDITION subquest_blade greater_than_equal_to 2}
					{CONDITION subquest_blade less_than 7}
				[/show_if]
				[command]
					[message]
						speaker=unit
						message=_ "Does the Black Blade have any presence here in Fort Bastille?"
					[/message]
					[message]
						speaker=Jessip
						message=_ "I doubt it. There were talk last month of a traitor amongst the spearmen ranks but Leo clamped down hard. Executed one or two, he did."
					[/message]
					[message]
						speaker=unit
						message=_ "So they don't operate around here?"
					[/message]
					[message]
						speaker=Jessip
						message=_ "Not likely. Most of their activity seems to confined to the north west. They're probably holed up on some rock over there."
					[/message]
					{VARIABLE log_blade.location_rumour yes}
				[/command]
			[/option]
				
		[/message]
	[/event]
	
	##########################################
	# Danielo
	##########################################
	
	[event]
	name=moveto
		[filter]
            side=1,2
            [filter_adjacent]
                id=Danielo
                side=3
            [/filter_adjacent]
  		[/filter]
  		# Prevent Danielo from talking if a new ship has already been bought, or if the galleon might be given
		[if]
		{CONDITION subquest_serpent greater_than 1}
		{CONDITION subquest_serpent less_than 4}
		[or]
			{CONDITION new_ship equals yes}
		[/or]
			[then]
				[message]
					speaker=Danielo
					message=_ "Sorry, I am very busy at the moment. Please come back later."
				[/message]
			[/then]
			[else]
				[message]
					speaker=Danielo
					message=_ "You need a new ship? You've come to the right place."
				[/message]
			[/else]
		[/if]
	[/event]
	
	[event]
		name=moveto
		first_time_only=no
		[filter]
            side=1,2
            canrecruit=yes
            [filter_adjacent]
                id=Danielo
                side=3
            [/filter_adjacent]
        [/filter]
        
        [if]
		{CONDITION subquest_serpent not_equals 2}
		{CONDITION subquest_serpent not_equals 3}
		{CONDITION new_ship not_equals yes}
			[then]
			
				[store_side]
					side=$side_number
					variable=shopper
				[/store_side]
				
						
				[message]
					speaker=narrator
					image=wesnoth-icon.png
					message= _ "What will you do?"
					
					# Walk on
					[option]
						description=_ "Walk on"
						[command]
						[/command]
					[/option]

					# Buy ship
					[option]
						description=_ "<span color='{TAM_BLUE}'>Buy a new ship</span>"
						[show_if]
							{CONDITION new_ship not_equals yes}
						[/show_if]
						[command]
							
							[message]
								speaker=Danielo
								message=_ "My ships are the finest you'll find in the royal kingdom."
							[/message]
							
							{VARIABLE finished no}
							[while]
								{CONDITION finished equals no}
								[do]
				
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										message= _ "Which ship do you want to buy?"
										
										# None
										[option]
											image=misc/blank-hex.png
											label= _" "
											description= _"None"
											[command]
												{VARIABLE finished yes}
											[/command]
										[/option]
			
										# Dhow
										[option]
											image="units/ships/dhow.png~TC(3,magenta)"
											label= _"100g"
											description= _"<span color='{TAM_BLUE}'>Dhow</span>"
											[show_if]
												{CONDITION ship_type not_equals TAM_Dhow}
											[/show_if]
											[command]
												[if]
													{CONDITION shopper.gold greater_than_equal_to 100}
													[then]
														[message]
															speaker=unit
															message=_ "I'll buy the dhow. Here's 100 gold."
														[/message]
														{TAM_GOLD $side_number -100}
														{VARIABLE ship_type TAM_Dhow}
														{VARIABLE rum_max 3}
														{VARIABLE jewels_max 3}
														{VARIABLE spices_max 3}
														{VARIABLE new_ship yes}
														{VARIABLE finished yes}
														[kill]
															x,y=40,20
															animate=no
														[/kill]
														[item]
															x,y=40,20
															image=units/ships/dhow.png~TC(1,magenta)
														[/item]
														[remove_item]
															x,y=35,18
														[/remove_item]
														{HIGHLIGHT_IMAGE 41 20 items/gohere.png misc/blank-hex.png}
													[/then]
												[/if]
											[/command]
										[/option]
										
										# Caravel
										[option]
											image="units/ships/caravel.png~TC(3,magenta)"
											label= _"125g"
											description= _"<span color='{TAM_BLUE}'>Caravel</span>"
											[show_if]
												{CONDITION ship_type not_equals TAM_Caravel}
											[/show_if]
											[command]
												[if]
													{CONDITION shopper.gold greater_than_equal_to 125}
													[then]
														[message]
															speaker=unit
															message=_ "I'll buy the caravel. Here's 125 gold."
														[/message]
														{TAM_GOLD $side_number -125}
														{VARIABLE ship_type TAM_Caravel}
														{VARIABLE rum_max 4}
														{VARIABLE jewels_max 4}
														{VARIABLE spices_max 4}
														{VARIABLE new_ship yes}
														{VARIABLE finished yes}
														[kill]
															x,y=42,21
															animate=no
														[/kill]
														[item]
															x,y=42,21
															image=units/ships/caravel.png~TC(1,magenta)
														[/item]
														[remove_item]
															x,y=35,18
														[/remove_item]
														{HIGHLIGHT_IMAGE 43 21 items/gohere.png misc/blank-hex.png}
													[/then]
												[/if]	
											[/command]
										[/option]
										
										# Frigate
										[option]
											image="units/ships/frigate.png~TC(3,magenta)"
											label= _"175g"
											description= _"<span color='{TAM_BLUE}'>Frigate</span>"
											[show_if]
												{CONDITION ship_type not_equals TAM_Frigate}
											[/show_if]
											[command]
												[if]
													{CONDITION shopper.gold greater_than_equal_to 175}
													[then]
														[message]
															speaker=unit
															message=_ "I'll buy the frigate. Here's 175 gold."
														[/message]
														{TAM_GOLD $side_number -175}
														{VARIABLE ship_type TAM_Frigate}
														{VARIABLE rum_max 5}
														{VARIABLE jewels_max 5}
														{VARIABLE spices_max 5}
														{VARIABLE new_ship yes}
														{VARIABLE finished yes}
														[kill]
															x,y=44,22
															animate=no
														[/kill]
														[item]
															x,y=44,22
															image=units/ships/frigate.png~TC(1,magenta)
														[/item]
														[remove_item]
															x,y=35,18
														[/remove_item]
														{HIGHLIGHT_IMAGE 45 22 items/gohere.png misc/blank-hex.png}
													[/then]
												[/if]			
											[/command]
										[/option]
										
									[/message]
									
								[/do]
							[/while]
							
							[if]
								{CONDITION new_ship equals yes}
								[then]
									[message]
										speaker=Danielo
										message=_ "A wise purchase. May she sail true."
									[/message]
									[message]
										speaker=narrator
										image=wesnoth-icon.png
										message= _ "What will you christen your new ship?"
										[text_input]
											variable=ship_name
											label=_ "Type Here: "
											max_chars=50
										[/text_input]
									[/message]
									#{TAM_STORE_UNIT race=vessel type=$ship_type (
									#{VARIABLE stored_unit.id $ship_name}
									#{VARIABLE stored_unit.name $ship_name}
									#{VARIABLE stored_unit.side 1}
									#{VARIABLE stored_unit.moves 0}
									#)}
									[message]
										speaker=unit
										message=_ "I christen this ship $ship_name|."
									[/message]
								[/then]
							[/if]
					
						[/command]
					[/option]
									
				[/message]
			[/then]
		[/if]
	[/event]
	
	[event]
		name=victory
		#[kill]
		#	type=TAM_Dhow,TAM_Caravel,TAM_Frigate,TAM_Galleon
		#	side=1
		#[/kill]
		{CLEAR_VARIABLE shopper}
		{CLEAR_VARIABLE new_ship}
		{CLEAR_VARIABLE jessip}
	[/event]

[/scenario]